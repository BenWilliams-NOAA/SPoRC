<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Run Closed Loop Simulations • SPoRC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run Closed Loop Simulations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SPoRC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Run Closed Loop Simulations</h1>
            
      

      <div class="d-none name"><code>h_closed_loop_simulations.Rmd</code></div>
    </div>

    
    
<p>In addition to being an estimation model, <code>SPoRC</code> also has
the capacity to conduct closed loop simulations to evaluate the impacts
of estimation model assumptions and harvest strategies on different
operating models. These closed loop simulations can be conducted on
either spatially-explicit or panmicitic populations. In this vignette,
we will demonstrate how to setup a single region, model conditioned
(Dusky rockfish) closed loop simulation. Closed loop simulations can
also be setup without any explicit conditioning on a given model (see
Simulation Testing vignette Cross Testing example) The vignette will
generally follow these steps:</p>
<ol style="list-style-type: decimal">
<li>Define a conditioned operating model (the truth),</li>
<li>Define an estimation model to use in the closed-loop
simulation,</li>
<li>Setup the simulation loop to run an operating and estimation
model,</li>
<li>Derive reference points and management advice (catch projections)
using estimates from the estimation model, and</li>
<li>Return management advice back into the annual cycle, completing the
closed loop simulation.</li>
</ol>
<p>Let us first load in the <code>SPoRC</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chengmatt.github.io/SPoRC">SPoRC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="define-operating-model">Define Operating Model<a class="anchor" aria-label="anchor" href="#define-operating-model"></a>
</h2>
<p>We can then define an operating model we want to condition a
population on. Here, parameter estiamtes will be based on model results
from Dusky rockfish. We will first load in the model list for Dusky
rockfish and redefine variables for use to condition the closed loop
simulation.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"dusky_rtmb_model"</span><span class="op">)</span> <span class="co"># load in dusky rtmb model for conditioning</span></span>
<span><span class="co"># define variables for use in setting up simulation</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">rep</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">rep</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">parameters</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">mapping</span></span>
<span><span class="va">sd_rep</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">sdrep</span></span></code></pre></div>
<p>Next, we condition the closed-loop simulation using the
<code>condition_closed_loop_simulations</code> function. The simulation
will run for 30 additional closed-loop years, with the initial model
years serving as a burn-in period. A total of 50 simulations will be
executed, assuming that data are available every fifth year.
Accordingly, assessments will be conducted every five years, with catch
advice set five years in advance. Future recruitment will be sampled
from the burn-in period, while uncertainty in the composition data
(input sample sizes) will follow the fishing mortality pattern.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">closed_loop_yrs</span> <span class="op">&lt;-</span> <span class="fl">30</span> <span class="co"># number of closed loop years to do</span></span>
<span><span class="va">burnin_years</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span> <span class="co"># number of conditioning years</span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">50</span> <span class="co"># number of simulations to do</span></span>
<span><span class="va">assess_freq</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># assessments every 5 years</span></span>
<span><span class="va">data_yr_freq</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># data year frequency</span></span>
<span></span>
<span><span class="co"># setup simulation list to condition closed loop simulations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># seed for resampling</span></span>
<span><span class="va">sim_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condition_closed_loop_simulations.html">condition_closed_loop_simulations</a></span><span class="op">(</span>closed_loop_yrs <span class="op">=</span> <span class="va">closed_loop_yrs</span>,</span>
<span>                                              n_sims <span class="op">=</span>  <span class="va">n_sims</span>,</span>
<span>                                              data <span class="op">=</span>  <span class="va">data</span>,</span>
<span>                                              parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>                                              mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>                                              sd_rep <span class="op">=</span> <span class="va">sd_rep</span>,</span>
<span>                                              rep <span class="op">=</span> <span class="va">rep</span>,</span>
<span>                                              random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                              recruitment_opt <span class="op">=</span> <span class="st">'resample_from_input'</span>,</span>
<span>                                              ISS_FishAgeComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span>,</span>
<span>                                              ISS_FishLenComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span>,</span>
<span>                                              <span class="op">)</span></span>
<span></span>
<span><span class="va">assessment_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">feedback_start_yr</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">assess_freq</span><span class="op">)</span> <span class="co"># assessment years</span></span>
<span><span class="va">years_to_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">burnin_years</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">$</span><span class="va">feedback_start_yr</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">data_yr_freq</span><span class="op">)</span><span class="op">)</span> <span class="co"># data years</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-management-options">Define Management Options<a class="anchor" aria-label="anchor" href="#define-management-options"></a>
</h2>
<p>Following the conditioning process, we define how reference points
are used to set catch advice and specify assumptions for catch
projections. Reference points are based on the most recent year’s
demographic rates and a single-region spawning potential ratio (SPR,
<span class="math inline">$F_{40%}$</span>). Projections follow a
threshold harvest control rule (HCR) that sets fishing mortality
according to stock status. Future recruitment is assumed to be
deterministic at the mean, and projections extend over the assessment
interval.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reference points options</span></span>
<span><span class="va">reference_points_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,           <span class="co"># number of years over which to average demographic rates</span></span>
<span>  SPR_x <span class="op">=</span> <span class="fl">0.4</span>,             <span class="co"># target spawning potential ratio</span></span>
<span>  calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,     <span class="co"># year used for recruitment in bx% calculations</span></span>
<span>  rec_age <span class="op">=</span> <span class="fl">4</span>,             <span class="co"># age at recruitment</span></span>
<span>  type <span class="op">=</span> <span class="st">'single_region'</span>,  <span class="co"># reference points calculated for a single region</span></span>
<span>  what <span class="op">=</span> <span class="st">"SPR"</span>             <span class="co"># method for reference points calculation (SPR)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># projection options</span></span>
<span><span class="va">proj_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,  <span class="co"># number of years to project (assessment interval + 1)</span></span>
<span>  HCR_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">frp</span>, <span class="va">brp</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">stock_status</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="va">brp</span>  <span class="co"># calculate stock status</span></span>
<span>    <span class="co"># Determine fishing mortality based on stock status</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span>  <span class="co"># full F if stock is above reference</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;</span> <span class="va">alpha</span> <span class="op">&amp;&amp;</span> <span class="va">stock_status</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span> <span class="op">*</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span>  <span class="co"># scaled F if stock is between alpha and reference</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">f</span> <span class="op">&lt;-</span> <span class="fl">0</span>  <span class="co"># no fishing if stock is below threshold</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,  <span class="co"># deterministic mean recruitment</span></span>
<span>  fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,             <span class="co"># fishing mortality follows the HCR</span></span>
<span>  bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span>               <span class="co"># no Beverton-Holt recruitment</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-estimation-model">Define Estimation Model<a class="anchor" aria-label="anchor" href="#define-estimation-model"></a>
</h2>
<p>Next, we specify an estimation model (EM) function that uses
simulated data to construct a SPoRC model. The helper function
<code>simulation_data_to_SPoRC</code> extracts and transforms the
simulated data into the dimensions required by <code>SPoRC.</code> For
Dusky rockfish, a single-region model is used with one fishery and one
survey fleet. The model assumes single-sex dynamics with 30 ages and
directly fits length compositions. Most demographic rates are fixed,
consistent with the operational assessment, and both fishery and survey
selectivities are modeled as logistic. No stock-recruitment relationship
is assumed, and annual recruitment is set to the mean value with annual
deviations constrained by <code>sigmaR.</code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Setup Estimation Model (EM) Inputs for SPoRC</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Prepares the estimation model input list for a given simulation year</span></span>
<span><span class="co">#' and replicate within the SPoRC closed-loop simulation framework.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param sim_env Simulation environment generated by `Setup_sim_env()`.</span></span>
<span><span class="co">#' @param y Integer. Current simulation year index.</span></span>
<span><span class="co">#' @param sim Integer. Simulation replicate index.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A fully configured EM input list suitable for fitting with `fit_model()`.</span></span>
<span><span class="va">setup_em</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Extract simulation data for current year and replicate</span></span>
<span>  <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_data_to_SPoRC.html">simulation_data_to_SPoRC</a></span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Model dimensions</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Dim.html">Setup_Mod_Dim</a></span><span class="op">(</span>years <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">y</span>, <span class="co"># vector of years</span></span>
<span>                              ages <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>, <span class="co"># vector of ages</span></span>
<span>                              lens <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_lens</span>, <span class="co"># number of lengths</span></span>
<span>                              n_regions <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="co"># number of regions</span></span>
<span>                              n_sexes <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="co"># number of sexes</span></span>
<span>                              n_fish_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span>, <span class="co"># number of fishery fleet</span></span>
<span>                              n_srv_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_srv_fleets</span>, <span class="co"># number of survey fleets</span></span>
<span>                              verbose <span class="op">=</span> <span class="cn">F</span></span>
<span>                              <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Recruitment setup</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Rec.html">Setup_Mod_Rec</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    do_rec_bias_ramp <span class="op">=</span> <span class="fl">1</span>, <span class="co"># Doing bias ramp, but basically setting it so that no lognormal bias correction happens (as in the dusky model)</span></span>
<span>    bias_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    sigmaR_switch <span class="op">=</span> <span class="fl">1</span>, <span class="co"># when to switch from early to late sigmaR (switch in first year)</span></span>
<span>    ln_sigmaR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1068576</span> , <span class="fl">2</span><span class="op">)</span>, <span class="co"># 2 values for early and late sigma</span></span>
<span>    <span class="co"># Starting values for early and late sigmaR</span></span>
<span>    rec_model <span class="op">=</span> <span class="st">"mean_rec"</span>,</span>
<span>    sigmaR_spec <span class="op">=</span> <span class="st">"fix"</span>, <span class="co"># fix early sigmaR and late sigmaR</span></span>
<span>    init_age_strc <span class="op">=</span> <span class="fl">1</span>, <span class="co"># geometric series to derive initial age structure</span></span>
<span>    ln_global_R0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.7</span><span class="op">)</span>, <span class="co"># starting value for mean_rec</span></span>
<span>    t_spawn <span class="op">=</span> <span class="fl">0</span> <span class="co"># spawn timing</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Biological setup</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Biologicals.html">Setup_Mod_Biologicals</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Data inputs</span></span>
<span>    WAA <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">WAA</span>,</span>
<span>    MatAA <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">MatAA</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    fit_lengths <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    SizeAgeTrans <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">SizeAgeTrans</span>,</span>
<span>    AgeingError <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">AgeingError</span>,</span>
<span>    M_spec <span class="op">=</span> <span class="st">"fix"</span>,     <span class="co"># fixing natural mortality</span></span>
<span>    Fixed_natmort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.07</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                        <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    addtocomp <span class="op">=</span> <span class="fl">0.00001</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Movement and tagging</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Tagging.html">Setup_Mod_Tagging</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>, UseTagging <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Movement.html">Setup_Mod_Movement</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    use_fixed_movement <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Fixed_Movement <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    do_recruits_move <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Fishery catch &amp; fishing mortality</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Catch_and_F.html">Setup_Mod_Catch_and_F</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Data inputs</span></span>
<span>    ObsCatch <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsCatch</span>,</span>
<span>    Catch_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    UseCatch <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseCatch</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    Use_F_pen <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    sigmaC_spec <span class="op">=</span> <span class="st">"fix"</span>,</span>
<span>    <span class="co"># Fixing sigma C and F</span></span>
<span>    ln_sigmaC <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ln_sigmaC</span>,</span>
<span>    ln_sigmaF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Survey selectivity and catchability</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_FishIdx_and_Comps.html">Setup_Mod_FishIdx_and_Comps</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Data inputs</span></span>
<span>    ObsFishIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishIdx</span>,</span>
<span>    ObsFishIdx_SE <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishIdx_SE</span>,</span>
<span>    UseFishIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishIdx</span>,</span>
<span>    ObsFishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishAgeComps</span>,</span>
<span>    ObsFishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishLenComps</span>,</span>
<span>    UseFishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span>,</span>
<span>    UseFishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishLenComps</span>,</span>
<span>    ISS_FishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_FishAgeComps</span>,</span>
<span>    ISS_FishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_FishLenComps</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    fish_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>,</span>
<span>    FishAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    FishLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    FishAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span>,</span>
<span>    FishLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Survey indices and compositions</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_SrvIdx_and_Comps.html">Setup_Mod_SrvIdx_and_Comps</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Data inputs</span></span>
<span>    ObsSrvIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvIdx</span>,</span>
<span>    ObsSrvIdx_SE <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvIdx_SE</span>,</span>
<span>    UseSrvIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvIdx</span>,</span>
<span>    ObsSrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvAgeComps</span>,</span>
<span>    ObsSrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvLenComps</span>,</span>
<span>    UseSrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span>,</span>
<span>    UseSrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvLenComps</span>,</span>
<span>    ISS_SrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_SrvAgeComps</span>,</span>
<span>    ISS_SrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_SrvLenComps</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    srv_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biom"</span><span class="op">)</span>,</span>
<span>    SrvAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    SrvLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    SrvAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span>,</span>
<span>    SrvLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Fishery selectivity and catchability</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Fishsel_and_Q.html">Setup_Mod_Fishsel_and_Q</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    fish_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>, <span class="co"># fishery selex model</span></span>
<span>    fish_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>, <span class="co"># whether to estiamte all fixed effects for fishery selectivity</span></span>
<span>    fish_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fix"</span><span class="op">)</span> <span class="co"># whether to estiamte all fixed effects for fishery catchability</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Survey selectivity and catchability</span></span>
<span>  <span class="va">srv_q_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    region <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    block <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    fleet <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    mu <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    sd <span class="op">=</span> <span class="fl">0.447213595</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Srvsel_and_Q.html">Setup_Mod_Srvsel_and_Q</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    <span class="co"># Model options</span></span>
<span>    srv_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>, <span class="co"># survey selectivity form</span></span>
<span>    srv_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>, <span class="co"># whether to estimate all fixed effects for survey selectivity</span></span>
<span>    srv_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,  <span class="co"># whether to estiamte all fixed effects for survey catchability</span></span>
<span>    Use_srv_q_prior <span class="op">=</span> <span class="fl">1</span>, <span class="co"># Use catchability prior</span></span>
<span>    srv_q_prior <span class="op">=</span> <span class="va">srv_q_prior</span>, <span class="co"># Use catchability prior</span></span>
<span>    <span class="co"># survey timing</span></span>
<span>    t_srv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Data weighting</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Weighting.html">Setup_Mod_Weighting</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    Wt_Catch <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_FishIdx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_SrvIdx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_Rec <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_F <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_Tagging <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    Wt_FishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                       <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_FishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                       <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_SrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_SrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-and-run-closed-loop-simulation">Define and Run Closed-Loop Simulation<a class="anchor" aria-label="anchor" href="#define-and-run-closed-loop-simulation"></a>
</h2>
<p>Once the Operating Model (OM), Estimation Model (EM), and management
options are specified, the closed-loop simulation can be implemented
using iterative loops.<br>
&gt; <strong>Note:</strong> This example is not parallelized, but
parallelization over the simulation loop (<code>n_sims</code>) can
improve computational efficiency. The simulation is also <strong>not
wrapped in a single function</strong>, which allows flexibility for
different management strategies (e.g., empirical harvest control rules,
combinations of empirical and model-based rules, or using
assessment-based catch advice in some years and empirical indicators in
others).</p>
<p>The simulation generally includes the following components: 1.
<strong>Simulation Loop</strong><br>
Iterates over each simulation (<code>sim in 1:n_sims</code>).<br>
2. <strong>Year Loop</strong><br>
Iterates over each modelled year (<code>y in 1:n_yrs</code>).<br>
3. <strong>Annual Dynamics</strong><br>
Within these loops, <code>run_annual_cycle(y, sim, sim_env)</code>
updates population dynamics, natural mortality, growth, maturity, and
movement.<br>
4. <strong>Management Feedback (optional)</strong><br>
Begins from a specified feedback year (<code>feedback_start_yr</code>).
During these years, assessments can be conducted.<br>
5. <strong>Assessment Model (optional)</strong><br>
If an assessment is run:<br>
- Use <code>setup_em(sim_env, y, sim)</code> to prepare EM inputs.<br>
- Optionally exclude certain years using
<code><a href="../reference/set_data_indicator_unused.html">set_data_indicator_unused()</a></code> (all years are still simulated
in <code>run_annual_cycle</code>).<br>
6. <strong>Reference Points (optional)</strong><br>
Compute reference points via
<code><a href="../reference/get_closed_loop_reference_points.html">get_closed_loop_reference_points()</a></code>, using either EM
estimates or true OM values.<br>
7. <strong>Catch Projections (optional)</strong><br>
Project the population forward to determine catch advice using either
true OM values or EM estimates.<br>
8. <strong>Convert Catch Advice to Fishing Mortality</strong><br>
TACs are converted to fishing mortality rates for the simulation to use
in the next year, completing the feedback loop.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># set seed</span></span>
<span><span class="va">sim_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_sim_env.html">Setup_sim_env</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">)</span> <span class="co"># Setup simulation environment using conditioned values</span></span>
<span></span>
<span><span class="co"># Start Simulation</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># Run Annual Dynamics -----------------------------------------------------</span></span>
<span>    <span class="fu"><a href="../reference/run_annual_cycle.html">run_annual_cycle</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">sim</span>, <span class="va">sim_env</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Start Management Feedback -----------------------------------------------</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">feedback_start_yr</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">assessment_years</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="va">dusky_input_list</span> <span class="op">&lt;-</span> <span class="fu">setup_em</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span> <span class="co"># setup model EM inputs for each year</span></span>
<span></span>
<span>        <span class="co"># Extract out data, parameters, and mapping</span></span>
<span>        <span class="va">asmt_data</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">data</span></span>
<span>        <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">par</span></span>
<span>        <span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">map</span></span>
<span></span>
<span>        <span class="co"># set data to 0 (assuming assessments are not conducted if no new data are availiable)</span></span>
<span>        <span class="va">asmt_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_data_indicator_unused.html">set_data_indicator_unused</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">asmt_data</span>,</span>
<span>                                               unused_years <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">years_to_use</span><span class="op">)</span>,</span>
<span>                                               what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FishIdx"</span>, <span class="st">"FishAgeComps"</span>, <span class="st">"SrvIdx"</span>, <span class="st">"SrvAgeComps"</span>, <span class="st">"FishLenComps"</span>, <span class="st">"SrvLenComps"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co">### Run Assessment ----------------------------------------------------------</span></span>
<span>        <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">asmt_data</span>,</span>
<span>                         <span class="va">parameters</span>,</span>
<span>                         <span class="va">mapping</span>,</span>
<span>                         random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         newton_loops <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                         silent <span class="op">=</span> <span class="cn">T</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>     <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">assessment_years</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>       <span class="co">### Get Reference Points ----------------------------------------------------</span></span>
<span>       <span class="va">reference_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_closed_loop_reference_points.html">get_closed_loop_reference_points</a></span><span class="op">(</span></span>
<span>         use_true_values <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>         sim_env <span class="op">=</span> <span class="va">sim_env</span>,</span>
<span>         asmt_data <span class="op">=</span> <span class="va">asmt_data</span>,</span>
<span>         asmt_rep <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>         y <span class="op">=</span> <span class="va">y</span>,</span>
<span>         sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>         reference_points_opt <span class="op">=</span> <span class="va">reference_points_opt</span>,</span>
<span>         n_proj_yrs <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span>       <span class="co">### Run Projections to Determine Catch Advice ---------------------------------------------------</span></span>
<span>       <span class="co"># Get inputs for projection</span></span>
<span>       <span class="va">tmp_terminal_NAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal numbers at age</span></span>
<span>       <span class="va">tmp_terminal_NAA0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal unfished numbers at age</span></span>
<span></span>
<span>       <span class="va">tmp_WAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age</span></span>
<span>       <span class="va">tmp_WAA_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">WAA_fish</span><span class="op">[</span>,<span class="va">y</span>,,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age fishery</span></span>
<span>       <span class="va">tmp_MatAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">MatAA</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># maturity at age</span></span>
<span>       <span class="va">tmp_fish_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span>,<span class="va">y</span>,,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># selectivity</span></span>
<span>       <span class="va">tmp_terminal_F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>,<span class="va">y</span>,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal fishing mortality</span></span>
<span>       <span class="va">tmp_natmort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span>,<span class="va">y</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># natural mortality</span></span>
<span>       <span class="va">tmp_recruitment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">y</span><span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># recruitment to use for projections</span></span>
<span>       <span class="va">tmp_sexratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">sexratio</span><span class="op">[</span>,<span class="va">y</span>,<span class="op">]</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># recruitment sex ratio</span></span>
<span>       <span class="va">tmp_Movement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="kw">for</span><span class="op">(</span><span class="va">proj_yr</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span><span class="op">)</span> <span class="va">tmp_Movement</span><span class="op">[</span>,,<span class="va">proj_yr</span>,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Movement</span><span class="op">[</span>,,<span class="va">y</span>,,<span class="op">]</span> <span class="co"># Movement projections</span></span>
<span></span>
<span>       <span class="co"># Do projection to get TAC</span></span>
<span>       <span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Do_Population_Projection.html">Do_Population_Projection</a></span><span class="op">(</span></span>
<span>         n_proj_yrs <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span>,</span>
<span>         n_regions <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>         n_ages <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>,</span>
<span>         n_sexes <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>         sexratio <span class="op">=</span> <span class="va">tmp_sexratio</span>,</span>
<span>         n_fish_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span>,</span>
<span>         do_recruits_move <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">do_recruits_move</span>,</span>
<span>         recruitment <span class="op">=</span> <span class="va">tmp_recruitment</span>,</span>
<span>         terminal_NAA <span class="op">=</span> <span class="va">tmp_terminal_NAA</span>,</span>
<span>         tmp_terminal_NAA0 <span class="op">=</span> <span class="va">tmp_terminal_NAA0</span>,</span>
<span>         terminal_F <span class="op">=</span> <span class="va">tmp_terminal_F</span>,</span>
<span>         natmort <span class="op">=</span> <span class="va">tmp_natmort</span>,</span>
<span>         WAA <span class="op">=</span> <span class="va">tmp_WAA</span>,</span>
<span>         WAA_fish <span class="op">=</span> <span class="va">tmp_WAA_fish</span>,</span>
<span>         MatAA <span class="op">=</span> <span class="va">tmp_MatAA</span>,</span>
<span>         fish_sel <span class="op">=</span> <span class="va">tmp_fish_sel</span>,</span>
<span>         Movement <span class="op">=</span> <span class="va">tmp_Movement</span>,</span>
<span>         f_ref_pt <span class="op">=</span> <span class="va">reference_points</span><span class="op">$</span><span class="va">f_ref_pt</span>,</span>
<span>         b_ref_pt <span class="op">=</span> <span class="va">reference_points</span><span class="op">$</span><span class="va">b_ref_pt</span>,</span>
<span>         HCR_function <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">HCR_function</span>,</span>
<span>         recruitment_opt <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">recruitment_opt</span>,</span>
<span>         fmort_opt <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">fmort_opt</span>,</span>
<span>         t_spawn <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">t_spawn</span>,</span>
<span>         bh_rec_opt <span class="op">=</span> <span class="va">proj_opt</span><span class="op">$</span><span class="va">bh_rec_opt</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span>       <span class="co"># Get TAC</span></span>
<span>       <span class="va">tmp_TAC</span> <span class="op">&lt;-</span> <span class="va">proj</span><span class="op">$</span><span class="va">proj_Catch</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="co"># get catch advice from projected year</span></span>
<span>     <span class="op">}</span></span>
<span></span>
<span>      <span class="co">### TAC to Fishing Mortality ------------------------------------------------</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">last_assess_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">assessment_years</span><span class="op">[</span><span class="va">assessment_years</span> <span class="op">&lt;=</span> <span class="va">y</span><span class="op">]</span><span class="op">)</span> <span class="co"># get last assessment year</span></span>
<span>        <span class="va">tac_year_index</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">last_assess_year</span> <span class="op">+</span> <span class="fl">1</span> <span class="co"># get years to index TACs</span></span>
<span>        <span class="va">rf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># set up region, fleet grid to bisection across</span></span>
<span>        <span class="va">tmp_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span> <span class="co"># do bisection to go from region and fleet specific catch to region and fleet specific F rates</span></span>
<span>          <span class="fu"><a href="../reference/bisection_F.html">bisection_F</a></span><span class="op">(</span></span>
<span>            f_guess <span class="op">=</span> <span class="fl">0.05</span>, <span class="co"># guess for fishing mortality rate</span></span>
<span>            catch <span class="op">=</span> <span class="va">tmp_TAC</span><span class="op">[</span><span class="va">r</span>, <span class="va">tac_year_index</span>, <span class="va">f</span><span class="op">]</span>, <span class="co"># catch values to use</span></span>
<span>            NAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span><span class="op">+</span><span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>, <span class="co"># numbers at age in simulation (truth)</span></span>
<span>            WAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span><span class="op">+</span><span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>, <span class="co"># weight-at-age in simulation (truth)</span></span>
<span>            natmort  <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span><span class="op">+</span><span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>, <span class="co"># natural mortality in simulation (truth)</span></span>
<span>            fish_sel <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span><span class="op">+</span><span class="fl">1</span>, , , <span class="va">f</span>, <span class="va">sim</span><span class="op">]</span> <span class="co"># fishery selectivity in simulation (truth)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span>, r <span class="op">=</span> <span class="va">rf_grid</span><span class="op">$</span><span class="va">r</span>, f <span class="op">=</span> <span class="va">rf_grid</span><span class="op">$</span><span class="va">f</span><span class="op">)</span></span>
<span>        <span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>,<span class="va">y</span><span class="op">+</span><span class="fl">1</span>,,<span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">tmp_f</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># assign bisection values back into simulation</span></span>
<span>      <span class="op">}</span> <span class="co"># end if</span></span>
<span></span>
<span>    <span class="op">}</span> <span class="co"># feedback year</span></span>
<span>  <span class="op">}</span> <span class="co"># end y loop</span></span>
<span><span class="op">}</span> <span class="co"># end sim loop</span></span></code></pre></div>
<p>We can then inspect some outputs from the closed loop simulation.
Note that all results are now saved in the <code>sim_env</code>
environment object. Plotted below are trajectories of catch, fishing
mortality, and spawning stock biomass for a given simulation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trajectories of spawning biomass</span></span>
<span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Sim <span class="op">=</span> <span class="va">Var3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Region</span>, <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'SSB'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Trajectories of catches</span></span>
<span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">TrueCatch</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var2</span>, <span class="va">Var4</span>, <span class="va">Var1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var1</span>, <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Year'</span>, y <span class="op">=</span> <span class="st">'Catch'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Trajectories of fishing mortality</span></span>
<span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var2</span>, <span class="va">Var4</span>, <span class="va">Var1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var1</span>, <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Fishing Mortality'</span>, x <span class="op">=</span> <span class="st">'Year'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/h_ssb_closed_loop.png"><img src="figures/h_catch_closed_loop.png"><img src="figures/h_fmort_closed_loop.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Cheng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
