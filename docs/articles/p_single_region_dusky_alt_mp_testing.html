<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Testing Management Procedures via Closed Loop Simulations (Dusky Rockfish) • SPoRC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Testing Management Procedures via Closed Loop Simulations (Dusky Rockfish)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SPoRC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Testing Management Procedures via Closed Loop Simulations (Dusky Rockfish)</h1>
            
      

      <div class="d-none name"><code>p_single_region_dusky_alt_mp_testing.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>We demonstrated how closed-loop simulations can be run in the <em>Run
Closed Loop Simulations</em> vignette. For an introductory walkthrough,
please refer to that vignette. Here, we demonstrate how to test multiple
management procedures (MPs) across different demographic scenarios to
evaluate the robustness and performance of alternative strategies. We
note that this is one way to define a closed-loop simulation. Users can
maintain flexibility in how the closed-loop is set up, for example by
defining MPs using empirical control rules, alternative reference
points, or custom projection strategies. This approach allows users to
tailor the simulation to their specific management questions or data
constraints.</p>
<p>In this vignette, six MPs will be evaluated:</p>
<ol style="list-style-type: decimal">
<li>
<strong>f0</strong> – No fishing, serving as a baseline for
comparison.<br>
</li>
<li>
<strong>f40_thresh</strong> – A threshold control rule using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{40\%}</annotation></semantics></math>
as reference points.<br>
Fishing mortality is set at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>B</mi><mo>≥</mo><msub><mi>B</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub></mrow><annotation encoding="application/x-tex">SSB \ge B_{40\%}</annotation></semantics></math>
and declines linearly as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">SSB</annotation></semantics></math>
falls below
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{40\%}</annotation></semantics></math>.<br>
No fishing occurs if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>B</mi><mo>≤</mo><msub><mi>B</mi><mrow><mn>5</mn><mi>%</mi></mrow></msub></mrow><annotation encoding="application/x-tex">SSB \le B_{5\%}</annotation></semantics></math>.<br>
This rule represents the default strategy used for Gulf of Alaska Dusky
Rockfish management (Omori et al., 2024).<br>
</li>
<li>
<strong>f40_const</strong> – A constant fishing mortality rate fixed
at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>,
regardless of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">SSB</annotation></semantics></math>.<br>
</li>
<li>
<strong>f40_steep</strong> – Similar to <strong>f40_thresh</strong>,
but with a steeper ramp, where the target biomass reference point is set
at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mn>60</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{60\%}</annotation></semantics></math>.<br>
</li>
<li>
<strong>f40_thresh_cap</strong> – As in <strong>f40_thresh</strong>,
but with catches capped at 3,000 t, approximating the mean of the
historical catch time series.<br>
</li>
<li>
<strong>f40_hybrid</strong> – A hybrid rule combining elements of
<strong>f40_thresh</strong>, <strong>f40_steep</strong>, and
<strong>f40_thresh_cap</strong>.</li>
</ol>
<p>Two demographic (recruitment) scenarios will be evaluated:</p>
<ol style="list-style-type: decimal">
<li>
<strong>rand</strong> – Recruitment is randomly resampled from the
historical time series to mimic past recruitment variability.<br>
</li>
<li>
<strong>crash</strong> – Recruitment follows Beverton–Holt dynamics
and declines sharply to mimic environmentally driven recruitment
collapses.<br>
During the first 23 years of the simulation period (2025–2046),
recruitment is simulated at reduced values<br>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>=</mo><mn>2.5</mn><mo>,</mo><mi>h</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">R_0 = 2.5, h = 0.5</annotation></semantics></math>),
followed by a recovery phase (2047–2074) with higher productivity<br>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>=</mo><mn>12</mn><mo>,</mo><mi>h</mi><mo>=</mo><mn>0.75</mn></mrow><annotation encoding="application/x-tex">R_0 = 12, h = 0.75</annotation></semantics></math>).</li>
</ol>
<p>The performance metrics evaluated in this vignette include:</p>
<ol style="list-style-type: decimal">
<li>Spawning stock biomass<br>
</li>
<li>Catch<br>
</li>
<li>Average annual variation in catch</li>
</ol>
<p>Let us first set up the simulation by loading the requisite packages
and data files.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>      </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span>       </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span>    </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>       </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span>          </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chengmatt.github.io/SPoRC">SPoRC</a></span><span class="op">)</span>         </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ggradar</span><span class="op">)</span>      </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"dusky_rtmb_model"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="estimation-model">Estimation Model<a class="anchor" aria-label="anchor" href="#estimation-model"></a>
</h3>
<p>Next, we set up the estimation model (EM) that will be used within
the closed-loop simulation framework. The helper function
<code>setup_em()</code> prepares all necessary inputs for the estimation
model for a given simulation year and replicate. It uses
<code><a href="../reference/simulation_data_to_SPoRC.html">SPoRC::simulation_data_to_SPoRC()</a></code> to convert the simulation
output into the correct input structure for the <code>SPoRC</code>
model.</p>
<p>In general, this EM follows the structure introduced in the
<em>Getting Started</em> vignette. It represents a **single-area,
single-sex, single-fishery, and single-survey model configuration. Both
fishery and survey fleets are modeled with logistic selectivity.
Recruitment follows a mean recruitment formulation, and the model is fit
to:</p>
<ul>
<li>Catches<br>
</li>
<li>Fishery age and length compositions<br>
</li>
<li>Survey age compositions</li>
</ul>
<p>Additionally, the survey index is fit with a prior on catchability
(<code>q</code>) to stabilize estimation.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Setup Estimation Model Inputs for Gulf of Alaska Dusky Rockfish</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Prepares the estimation model input list for a given simulation year</span></span>
<span><span class="co">#' and replicate within the SPoRC closed-loop simulation framework.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param sim_env Simulation environment generated by `Setup_sim_env()`.</span></span>
<span><span class="co">#' @param y Integer. Current simulation year index.</span></span>
<span><span class="co">#' @param sim Integer. Simulation replicate index.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A fully configured EM input list suitable for fitting with `fit_model()`.</span></span>
<span><span class="va">setup_em</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Extract simulation data for current year and replicate</span></span>
<span>  <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/simulation_data_to_SPoRC.html">simulation_data_to_SPoRC</a></span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Initialize model dimensions</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Dim.html">Setup_Mod_Dim</a></span><span class="op">(</span></span>
<span>    years <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">y</span>,</span>
<span>    ages <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>,</span>
<span>    lens <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_lens</span>,</span>
<span>    n_regions <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>    n_sexes <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>    n_fish_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span>,</span>
<span>    n_srv_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_srv_fleets</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure recruitment model</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Rec.html">Setup_Mod_Rec</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    do_rec_bias_ramp <span class="op">=</span> <span class="fl">1</span>,  <span class="co"># Enable bias ramp (no lognormal bias correction)</span></span>
<span>    bias_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    sigmaR_switch <span class="op">=</span> <span class="fl">1</span>,  <span class="co"># Switch from early to late sigmaR in first year</span></span>
<span>    ln_sigmaR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1068576</span>, <span class="fl">2</span><span class="op">)</span>,  <span class="co"># Early and late sigma values</span></span>
<span>    rec_model <span class="op">=</span> <span class="st">"mean_rec"</span>,</span>
<span>    sigmaR_spec <span class="op">=</span> <span class="st">"fix"</span>,  <span class="co"># Fix early and late sigmaR</span></span>
<span>    init_age_strc <span class="op">=</span> <span class="fl">1</span>,  <span class="co"># Geometric series for initial age structure</span></span>
<span>    ln_global_R0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.7</span><span class="op">)</span>,  <span class="co"># Starting value for mean recruitment</span></span>
<span>    t_spawn <span class="op">=</span> <span class="fl">0</span>  <span class="co"># Spawn timing</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure biological parameters</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Biologicals.html">Setup_Mod_Biologicals</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    WAA <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">WAA</span>,</span>
<span>    MatAA <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">MatAA</span>,</span>
<span>    fit_lengths <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    SizeAgeTrans <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">SizeAgeTrans</span>,</span>
<span>    AgeingError <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">AgeingError</span>,</span>
<span>    M_spec <span class="op">=</span> <span class="st">"fix"</span>,  <span class="co"># Fix natural mortality at 0.07</span></span>
<span>    Fixed_natmort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.07</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>,</span>
<span>      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>    addtocomp <span class="op">=</span> <span class="fl">0.00001</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure movement and tagging (no tagging used)</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Tagging.html">Setup_Mod_Tagging</a></span><span class="op">(</span>input_list <span class="op">=</span> <span class="va">input_list</span>, UseTagging <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Movement.html">Setup_Mod_Movement</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    use_fixed_movement <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Fixed_Movement <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    do_recruits_move <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure fishery catch and fishing mortality</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Catch_and_F.html">Setup_Mod_Catch_and_F</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    ObsCatch <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsCatch</span>,</span>
<span>    Catch_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    UseCatch <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseCatch</span>,</span>
<span>    Use_F_pen <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    sigmaC_spec <span class="op">=</span> <span class="st">"fix"</span>,</span>
<span>    ln_sigmaC <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ln_sigmaC</span>,</span>
<span>    ln_sigmaF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure fishery indices and compositions</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_FishIdx_and_Comps.html">Setup_Mod_FishIdx_and_Comps</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    ObsFishIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishIdx</span>,</span>
<span>    ObsFishIdx_SE <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishIdx_SE</span>,</span>
<span>    UseFishIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishIdx</span>,</span>
<span>    ObsFishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishAgeComps</span>,</span>
<span>    ObsFishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsFishLenComps</span>,</span>
<span>    UseFishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span>,</span>
<span>    UseFishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseFishLenComps</span>,</span>
<span>    ISS_FishAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_FishAgeComps</span>,</span>
<span>    ISS_FishLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_FishLenComps</span>,</span>
<span>    fish_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>,</span>
<span>    FishAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    FishLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    FishAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span>,</span>
<span>    FishLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure survey indices and compositions</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_SrvIdx_and_Comps.html">Setup_Mod_SrvIdx_and_Comps</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    ObsSrvIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvIdx</span>,</span>
<span>    ObsSrvIdx_SE <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvIdx_SE</span>,</span>
<span>    UseSrvIdx <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvIdx</span>,</span>
<span>    ObsSrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvAgeComps</span>,</span>
<span>    ObsSrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ObsSrvLenComps</span>,</span>
<span>    UseSrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span>,</span>
<span>    UseSrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">UseSrvLenComps</span>,</span>
<span>    ISS_SrvAgeComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_SrvAgeComps</span>,</span>
<span>    ISS_SrvLenComps <span class="op">=</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">ISS_SrvLenComps</span>,</span>
<span>    srv_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biom"</span><span class="op">)</span>,</span>
<span>    SrvAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    SrvLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>    SrvAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span>,</span>
<span>    SrvLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure fishery selectivity and catchability</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Fishsel_and_Q.html">Setup_Mod_Fishsel_and_Q</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    fish_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>,</span>
<span>    fish_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>    fish_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fix"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure survey selectivity and catchability with prior</span></span>
<span>  <span class="va">srv_q_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    region <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    block <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    fleet <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    mu <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    sd <span class="op">=</span> <span class="fl">0.447213595</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Srvsel_and_Q.html">Setup_Mod_Srvsel_and_Q</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    srv_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>,</span>
<span>    srv_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>    srv_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>    Use_srv_q_prior <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    srv_q_prior <span class="op">=</span> <span class="va">srv_q_prior</span>,</span>
<span>    t_srv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Configure data weighting</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Weighting.html">Setup_Mod_Weighting</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    Wt_Catch <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_FishIdx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_SrvIdx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_Rec <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_F <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Wt_Tagging <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    Wt_FishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                       <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_FishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                       <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_SrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Wt_SrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                      <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="projection-options">Projection Options<a class="anchor" aria-label="anchor" href="#projection-options"></a>
</h3>
<p>As part of the closed-loop simulation process, estimates from the
estimation model (EM) are passed into a projection model, together with
a defined management procedure (MP), to derive catch advice. The
following helper function can be embedded within a closed-loop
simulation to generate catch advice from EM outputs.</p>
<p>Further details on how the <code><a href="../reference/Do_Population_Projection.html">Do_Population_Projection()</a></code>
function operates and how it is applied are provided in the <em>Deriving
Reference Points, Catch Advice, and Projections</em> vignette. In
general, the following function extracts estimates from the terminal
year to condition the population projections and derive catch
advice.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Run Population Projection</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Performs forward projection of the population using assessment model outputs</span></span>
<span><span class="co">#' and management procedure specifications.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param sim_env Simulation environment</span></span>
<span><span class="co">#' @param obj Fitted assessment model object</span></span>
<span><span class="co">#' @param reference_points Calculated reference points</span></span>
<span><span class="co">#' @param asmt_data Assessment data list</span></span>
<span><span class="co">#' @param mp_config Management procedure configuration</span></span>
<span><span class="co">#' @param y Current year index</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Projection results including projected catch</span></span>
<span><span class="va">run_projection</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">obj</span>, <span class="va">reference_points</span>, <span class="va">asmt_data</span>, <span class="va">mp_config</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">n_proj</span> <span class="op">&lt;-</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span></span>
<span></span>
<span>  <span class="co"># Extract terminal year numbers-at-age</span></span>
<span>  <span class="va">tmp_terminal_NAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>, <span class="va">y</span>, , <span class="op">]</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">tmp_terminal_NAA0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA0</span><span class="op">[</span>, <span class="va">y</span>, , <span class="op">]</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Replicate biological parameters for projection years</span></span>
<span>  <span class="va">tmp_WAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span>, <span class="va">y</span>, , <span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">tmp_WAA_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">WAA_fish</span><span class="op">[</span>, <span class="va">y</span>, , , <span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>,</span>
<span>            <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">tmp_MatAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">MatAA</span><span class="op">[</span>, <span class="va">y</span>, , <span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">tmp_fish_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span>, <span class="va">y</span>, , , <span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>,</span>
<span>            <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">tmp_natmort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span>, <span class="va">y</span>, , <span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract terminal fishing mortality</span></span>
<span>  <span class="va">tmp_terminal_F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>, <span class="va">y</span>, <span class="op">]</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract recruitment history</span></span>
<span>  <span class="va">tmp_recruitment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">y</span><span class="op">]</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Replicate sex ratio for projection years</span></span>
<span>  <span class="va">tmp_sexratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_proj</span>, <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">sexratio</span><span class="op">[</span>, <span class="va">y</span>, <span class="op">]</span><span class="op">)</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Replicate movement matrix for projection years</span></span>
<span>  <span class="va">tmp_Movement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span></span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">n_proj</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">asmt_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, <span class="va">asmt_data</span><span class="op">$</span><span class="va">n_sexes</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">proj_yr</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_proj</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tmp_Movement</span><span class="op">[</span>, , <span class="va">proj_yr</span>, , <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Movement</span><span class="op">[</span>, , <span class="va">y</span>, , <span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Execute population projection</span></span>
<span>  <span class="va">proj_results</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/Do_Population_Projection.html">Do_Population_Projection</a></span><span class="op">(</span></span>
<span>    n_proj_yrs <span class="op">=</span> <span class="va">n_proj</span>,</span>
<span>    n_regions <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>    n_ages <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_ages</span>,</span>
<span>    n_sexes <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>    sexratio <span class="op">=</span> <span class="va">tmp_sexratio</span>,</span>
<span>    n_fish_fleets <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span>,</span>
<span>    do_recruits_move <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">do_recruits_move</span>,</span>
<span>    recruitment <span class="op">=</span> <span class="va">tmp_recruitment</span>,</span>
<span>    terminal_NAA <span class="op">=</span> <span class="va">tmp_terminal_NAA</span>,</span>
<span>    terminal_NAA0 <span class="op">=</span> <span class="va">tmp_terminal_NAA0</span>,</span>
<span>    terminal_F <span class="op">=</span> <span class="va">tmp_terminal_F</span>,</span>
<span>    natmort <span class="op">=</span> <span class="va">tmp_natmort</span>,</span>
<span>    WAA <span class="op">=</span> <span class="va">tmp_WAA</span>,</span>
<span>    WAA_fish <span class="op">=</span> <span class="va">tmp_WAA_fish</span>,</span>
<span>    MatAA <span class="op">=</span> <span class="va">tmp_MatAA</span>,</span>
<span>    fish_sel <span class="op">=</span> <span class="va">tmp_fish_sel</span>,</span>
<span>    Movement <span class="op">=</span> <span class="va">tmp_Movement</span>,</span>
<span>    f_ref_pt <span class="op">=</span> <span class="va">reference_points</span><span class="op">$</span><span class="va">f_ref_pt</span>,</span>
<span>    b_ref_pt <span class="op">=</span> <span class="va">reference_points</span><span class="op">$</span><span class="va">virgin_b_ref_pt</span> <span class="op">*</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">reference_points_opt</span><span class="op">$</span><span class="va">B_x</span>,</span>
<span>    HCR_function <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">HCR_function</span>,</span>
<span>    recruitment_opt <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">recruitment_opt</span>,</span>
<span>    fmort_opt <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">fmort_opt</span>,</span>
<span>    t_spawn <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">t_spawn</span>,</span>
<span>    bh_rec_opt <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">bh_rec_opt</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">proj_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="functions-to-determine-catch">Functions to Determine Catch<a class="anchor" aria-label="anchor" href="#functions-to-determine-catch"></a>
</h3>
<p>Next, we define functions that determine how catches are constrained
and how they translate into fishing mortality within the closed-loop
simulation.</p>
<p>In general, the helper functions below establish the feedback between
catch advice and the operating model. The first function applies
management rules or constraints (i.e., caps) to the total allowable
catch (TAC). These constraints are applied through a user-specified
function <code>catch_opt_func</code>, which modifies the input catch
advice based on management procedures defined later.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Apply Catch Constraints</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Applies management procedure catch constraints (e.g., caps) to projected catch.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param tmp_TAC Array of projected TAC values</span></span>
<span><span class="co">#' @param catch_opt_func Function defining catch constraints</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Modified TAC array with constraints applied</span></span>
<span><span class="va">apply_catch_constraints</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tmp_TAC</span>, <span class="va">catch_opt_func</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tmp_TAC</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tmp_TAC</span><span class="op">[</span>, <span class="va">j</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">catch_opt_func</span><span class="op">(</span>catch <span class="op">=</span> <span class="va">tmp_TAC</span><span class="op">[</span>, <span class="va">j</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">tmp_TAC</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The next function converts the (possibly constrained) TAC into a
corresponding fishing mortality rate (<code>Fmort</code>) used by the
operating model. This function uses a bisection algorithm to find the
value of fishing mortality that achieves the specified TAC for each
region and fleet combination. The updated <code>Fmort</code> values are
then stored in the simulation environment for use in the next time step
of the closed-loop cycle.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Convert TAC to Fishing Mortality</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Uses bisection method to find fishing mortality rate that achieves target TAC.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param sim_env Simulation environment</span></span>
<span><span class="co">#' @param tmp_TAC Target total allowable catch</span></span>
<span><span class="co">#' @param y Current year index</span></span>
<span><span class="co">#' @param sim Simulation replicate index</span></span>
<span><span class="co">#' @param assessment_years Vector of assessment year indices</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Updated simulation environment with new fishing mortality rates</span></span>
<span><span class="va">tac_to_fmort</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">tmp_TAC</span>, <span class="va">y</span>, <span class="va">sim</span>, <span class="va">assessment_years</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Find most recent assessment year</span></span>
<span>  <span class="va">last_assess_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">assessment_years</span><span class="op">[</span><span class="va">assessment_years</span> <span class="op">&lt;=</span> <span class="va">y</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">tac_year_index</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">last_assess_year</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Create grid of region-fleet combinations</span></span>
<span>  <span class="va">rf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>    r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span>,</span>
<span>    f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Solve for F that achieves target catch for each region-fleet combination</span></span>
<span>  <span class="va">tmp_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/bisection_F.html">bisection_F</a></span><span class="op">(</span></span>
<span>        f_guess <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>        catch <span class="op">=</span> <span class="va">tmp_TAC</span><span class="op">[</span><span class="va">r</span>, <span class="va">tac_year_index</span>, <span class="va">f</span><span class="op">]</span>,</span>
<span>        NAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>,</span>
<span>        WAA <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>,</span>
<span>        natmort <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , , <span class="va">sim</span><span class="op">]</span>,</span>
<span>        fish_sel <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span><span class="va">r</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , , <span class="va">f</span>, <span class="va">sim</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    r <span class="op">=</span> <span class="va">rf_grid</span><span class="op">$</span><span class="va">r</span>,</span>
<span>    f <span class="op">=</span> <span class="va">rf_grid</span><span class="op">$</span><span class="va">f</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Update fishing mortality in simulation environment</span></span>
<span>  <span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">tmp_f</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">sim_env</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sim_env</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="management-procedures">Management Procedures<a class="anchor" aria-label="anchor" href="#management-procedures"></a>
</h3>
<p>MPs define how catch advice is generated and applied within the
closed-loop simulation. Each MP defined here includes rules for
reference point calculation, control rule shape, and catch
implementation. The helper functions below specify the shape of the
control rules used across the different MPs. The <em>threshold</em> rule
reduces fishing mortality as spawning biomass declines below a biomass
reference point, while the <em>constant</em> rule maintains fishing
mortality at a fixed rate regardless of biomass status.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Threshold Harvest Control Rule</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Implements a threshold HCR where F is reduced linearly as biomass declines</span></span>
<span><span class="co">#' below the target biomass reference point.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x Current biomass</span></span>
<span><span class="co">#' @param frp Fishing mortality reference point (target F)</span></span>
<span><span class="co">#' @param brp Biomass reference point (target biomass)</span></span>
<span><span class="co">#' @param alpha Minimum biomass threshold (as fraction of brp)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Fishing mortality rate</span></span>
<span><span class="va">HCR_threshold</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">frp</span>, <span class="va">brp</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stock_status</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="va">brp</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span> <span class="op">*</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Constant Harvest Control Rule</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Implements a constant catch HCR where F remains at the reference level</span></span>
<span><span class="co">#' regardless of stock status.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x Current biomass (unused)</span></span>
<span><span class="co">#' @param frp Fishing mortality reference point (target F)</span></span>
<span><span class="co">#' @param brp Biomass reference point (unused)</span></span>
<span><span class="co">#' @param alpha Minimum biomass threshold (unused)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Fishing mortality rate (constant at frp)</span></span>
<span><span class="va">HCR_constant</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">frp</span>, <span class="va">brp</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">frp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The list below defines the specific MPs used in this example. Each
configuration represents a different management strategy, varying in how
strongly it responds to changes in biomass and whether catch caps are
imposed. Each MP has the following components in this example:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Reference point options
(<code>reference_points_opt</code>)</strong> — specify how biological
reference points are calculated (e.g., target spawning potential ratio,
biomass thresholds).<br>
</li>
<li>
<strong>Projection options (<code>proj_opt</code>)</strong> — define
the harvest control rule (HCR) and how recruitment and fishing mortality
are handled during projections.<br>
</li>
<li>
<strong>Catch options (<code>catch_opt</code>)</strong> — optionally
constrain catches according to management limits (e.g., catch
caps).</li>
</ol>
<p>Users have flexibility to modify and extend this structure to fit
their specific modeling objectives.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span>  <span class="co"># 1. No fishing</span></span>
<span>  <span class="co"># Serves as a baseline scenario. No assessment, projection, or catch is applied.</span></span>
<span>  f0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># 2. F40% with B40% threshold</span></span>
<span>  <span class="co"># The assessment is performed and reference points are calculated based on an SPR of 40%.</span></span>
<span>  <span class="co"># A threshold rule (B40%) is applied, where F declines linearly as biomass drops below 40% of B_SPR.</span></span>
<span>  f40_thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      SPR_x <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      rec_age <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      type <span class="op">=</span> <span class="st">'single_region'</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"SPR"</span>,</span>
<span>      B_x <span class="op">=</span> <span class="fl">0.4</span></span>
<span>    <span class="op">)</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      HCR_function <span class="op">=</span> <span class="va">HCR_threshold</span>,</span>
<span>      recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,</span>
<span>      fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,</span>
<span>      bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">catch</span>, <span class="va">prev_catch</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">catch_cap</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="va">catch</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># 3. F40% constant</span></span>
<span>  <span class="co"># Similar to f40_thresh, but no biomass threshold is applied.</span></span>
<span>  <span class="co"># Fishing mortality remains constant at F40%, regardless of biomass status.</span></span>
<span>  f40_const <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      SPR_x <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      rec_age <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      type <span class="op">=</span> <span class="st">'single_region'</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"SPR"</span>,</span>
<span>      B_x <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      HCR_function <span class="op">=</span> <span class="va">HCR_constant</span>,</span>
<span>      recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,</span>
<span>      fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,</span>
<span>      bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">catch</span>, <span class="va">prev_catch</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">catch_cap</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="va">catch</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># 4. F40% with B40% threshold and 3k ton catch cap</span></span>
<span>  <span class="co"># Same as f40_thresh, but adds an upper limit on allowable catch (3,000 tons).</span></span>
<span>  <span class="co"># The cap is applied after control rule-based advice is generated.</span></span>
<span>  f40_thresh_cap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      SPR_x <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      rec_age <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      type <span class="op">=</span> <span class="st">'single_region'</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"SPR"</span>,</span>
<span>      B_x <span class="op">=</span> <span class="fl">0.4</span></span>
<span>    <span class="op">)</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      HCR_function <span class="op">=</span> <span class="va">HCR_threshold</span>,</span>
<span>      recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,</span>
<span>      fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,</span>
<span>      bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">catch</span>, <span class="va">prev_catch</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">catch_cap</span> <span class="op">=</span> <span class="fl">3000</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">catch</span>, <span class="va">catch_cap</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># 5. F40% with B60% threshold</span></span>
<span>  <span class="co"># A steeper control rule that initiates F reduction earlier (when biomass &lt; 60% of B_SPR),</span></span>
<span>  <span class="co"># providing more precautionary harvest control at moderate depletion levels.</span></span>
<span>  f40_steep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      SPR_x <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      rec_age <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      type <span class="op">=</span> <span class="st">'single_region'</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"SPR"</span>,</span>
<span>      B_x <span class="op">=</span> <span class="fl">0.6</span></span>
<span>    <span class="op">)</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      HCR_function <span class="op">=</span> <span class="va">HCR_threshold</span>,</span>
<span>      recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,</span>
<span>      fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,</span>
<span>      bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">catch</span>, <span class="va">prev_catch</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">catch_cap</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="va">catch</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># 6. F40% hybrid: B60% threshold with 3k ton catch cap</span></span>
<span>  <span class="co"># Combines a precautionary threshold (B60%) with a hard catch cap (3,000 tons).</span></span>
<span>  <span class="co"># This MP reduces F more aggressively at lower biomass and constrains annual catches</span></span>
<span>  <span class="co"># to prevent excessive harvest in high-recruitment years.</span></span>
<span>  f40_hybrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    skip_assessment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    reference_points_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_avg_yrs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      SPR_x <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      rec_age <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      type <span class="op">=</span> <span class="st">'single_region'</span>,</span>
<span>      what <span class="op">=</span> <span class="st">"SPR"</span>,</span>
<span>      B_x <span class="op">=</span> <span class="fl">0.6</span></span>
<span>    <span class="op">)</span>,</span>
<span>    proj_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_proj_yrs <span class="op">=</span> <span class="va">assess_freq</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      HCR_function <span class="op">=</span> <span class="va">HCR_threshold</span>,</span>
<span>      recruitment_opt <span class="op">=</span> <span class="st">'mean_rec'</span>,</span>
<span>      fmort_opt <span class="op">=</span> <span class="st">'HCR'</span>,</span>
<span>      bh_rec_opt <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    catch_opt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">catch</span>, <span class="va">prev_catch</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">catch_cap</span> <span class="op">=</span> <span class="fl">3000</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">catch</span>, <span class="va">catch_cap</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation-loop-single-replicate">Simulation Loop (Single Replicate)<a class="anchor" aria-label="anchor" href="#simulation-loop-single-replicate"></a>
</h3>
<p>The core of the closed-loop simulation involves iterating over years
and replicates to simulate population dynamics, assessments, and
management feedback. At each simulation year, the population is updated
according to biological processes, recruitment, and fishing mortality.
When the feedback period is reached, management procedures are applied
based on the latest assessment results or, in some cases, skipped if the
MP specifies no fishing (e.g., F = 0). Assessment model inputs are
prepared using the <code>setup_em</code> helper, and the model is fit to
available data (via <code>fit_model</code>). Once the assessment is
complete, reference points are calculated, forward projections are run,
and catch advice is determined. Catch constraints such as caps can be
applied before converting the advice into the true fishing mortality
rates used in the operating models for the next year. This
single-replicate loop serves as the building block for running multiple
replicates in parallel, allowing us to evaluate the robustness and
performance of different MPs under repeated simulations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Run Single Simulation Replicate</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Executes one complete closed-loop simulation replicate including population</span></span>
<span><span class="co">#' dynamics, assessments, and management feedback.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param sim Simulation replicate index</span></span>
<span><span class="co">#' @param sim_list Simulation configuration list</span></span>
<span><span class="co">#' @param mp_config Management procedure configuration</span></span>
<span><span class="co">#' @param assessment_years Vector of years when assessments occur</span></span>
<span><span class="co">#' @param years_to_use Vector of years with available data</span></span>
<span><span class="co">#' @param assess_freq Assessment frequency (years)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return List containing simulation results (SSB, catch, F, NAA)</span></span>
<span><span class="va">run_single_replicate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span>, <span class="va">sim_list</span>, <span class="va">mp_config</span>, <span class="va">assessment_years</span>,</span>
<span>                                 <span class="va">years_to_use</span>, <span class="va">assess_freq</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Initialize simulation environment</span></span>
<span>  <span class="va">sim_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_sim_env.html">Setup_sim_env</a></span><span class="op">(</span><span class="va">sim_list</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Loop through all simulation years</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Execute annual population dynamics</span></span>
<span>    <span class="fu"><a href="../reference/run_annual_cycle.html">run_annual_cycle</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">sim</span>, <span class="va">sim_env</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Management feedback loop (after burn-in period)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">y</span> <span class="op">&gt;=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">feedback_start_yr</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Check if MP skips assessments (e.g., F=0)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">mp_config</span><span class="op">$</span><span class="va">skip_assessment</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">skip_assessment</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>, <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span>, , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Normal assessment and management procedure</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">y</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">assessment_years</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="co"># Prepare estimation model inputs</span></span>
<span>          <span class="va">dusky_input_list</span> <span class="op">&lt;-</span> <span class="fu">setup_em</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">y</span>, <span class="va">sim</span><span class="op">)</span></span>
<span>          <span class="va">asmt_data</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">data</span></span>
<span>          <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">par</span></span>
<span>          <span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">dusky_input_list</span><span class="op">$</span><span class="va">map</span></span>
<span></span>
<span>          <span class="co"># Set indicators for unused data years to 0</span></span>
<span>          <span class="va">asmt_data</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/set_data_indicator_unused.html">set_data_indicator_unused</a></span><span class="op">(</span></span>
<span>            data <span class="op">=</span> <span class="va">asmt_data</span>,</span>
<span>            unused_years <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">years_to_use</span><span class="op">)</span>,</span>
<span>            what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FishIdx"</span>, <span class="st">"FishAgeComps"</span>, <span class="st">"SrvIdx"</span>, <span class="st">"SrvAgeComps"</span>, <span class="st">"FishLenComps"</span>, <span class="st">"SrvLenComps"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="co"># Fit assessment model with error handling</span></span>
<span>          <span class="va">fit_result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>            <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span></span>
<span>              <span class="va">asmt_data</span>, <span class="va">parameters</span>, <span class="va">mapping</span>,</span>
<span>              random <span class="op">=</span> <span class="cn">NULL</span>, newton_loops <span class="op">=</span> <span class="fl">1</span>, silent <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Model fit failed for replicate %d in year %d: %s"</span>,</span>
<span>                            <span class="va">sim</span>, <span class="va">y</span>, <span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>          <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>          <span class="co"># If model fitting failed, return NA results</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">fit_result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>              sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>              rec <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>              ssb <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>              catch <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>              fmort <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>              naa <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>              failed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              failure_year <span class="op">=</span> <span class="va">y</span></span>
<span>            <span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span></span>
<span>          <span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">fit_result</span></span>
<span></span>
<span>          <span class="co"># Calculate biological reference points</span></span>
<span>          <span class="va">reference_points</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/get_closed_loop_reference_points.html">get_closed_loop_reference_points</a></span><span class="op">(</span></span>
<span>            use_true_values <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            sim_env <span class="op">=</span> <span class="va">sim_env</span>,</span>
<span>            asmt_data <span class="op">=</span> <span class="va">asmt_data</span>,</span>
<span>            asmt_rep <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>            y <span class="op">=</span> <span class="va">y</span>,</span>
<span>            sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>            reference_points_opt <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">reference_points_opt</span>,</span>
<span>            n_proj_yrs <span class="op">=</span> <span class="va">mp_config</span><span class="op">$</span><span class="va">proj_opt</span><span class="op">$</span><span class="va">n_proj_yrs</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="co"># Run forward projections</span></span>
<span>          <span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu">run_projection</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">obj</span>, <span class="va">reference_points</span>, <span class="va">asmt_data</span>, <span class="va">mp_config</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span>          <span class="co"># Apply catch constraints (e.g., caps)</span></span>
<span>          <span class="va">tmp_TAC</span> <span class="op">&lt;-</span> <span class="fu">apply_catch_constraints</span><span class="op">(</span></span>
<span>            <span class="va">proj</span><span class="op">$</span><span class="va">proj_Catch</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>            <span class="va">mp_config</span><span class="op">$</span><span class="va">catch_opt</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="co"># Convert TAC to fishing mortality for next year</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">n_yrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">sim_env</span> <span class="op">&lt;-</span> <span class="fu">tac_to_fmort</span><span class="op">(</span><span class="va">sim_env</span>, <span class="va">tmp_TAC</span>, <span class="va">y</span>, <span class="va">sim</span>, <span class="va">assessment_years</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Return successful replicate results</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>    rec <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">Rec</span><span class="op">[</span>,,<span class="va">sim</span>,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>    ssb <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">SSB</span><span class="op">[</span>, , <span class="va">sim</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>    catch <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">TrueCatch</span><span class="op">[</span>, , , <span class="va">sim</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>    fmort <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>, , , <span class="va">sim</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>    naa <span class="op">=</span> <span class="va">sim_env</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>, , , , <span class="va">sim</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>    failed <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation-loop-parrallelized">Simulation Loop (Parrallelized)<a class="anchor" aria-label="anchor" href="#simulation-loop-parrallelized"></a>
</h3>
<p>For efficiency, simulations can be executed in parallel across
multiple management procedures and replicates. The
<code>run_parallel_simulations</code> function sets up a parallel
cluster, exports necessary functions and objects, and runs each
replicate simultaneously. Results from each replicate are collected and
stored in arrays for spawning biomass, catch, fishing mortality, and
numbers-at-age. Users can modify this in a custom manner to extract
additional results necessary for their unique applications.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Run Parallel Simulations</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Executes multiple management procedures in parallel across all replicates.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param mp_list List of management procedure configurations</span></span>
<span><span class="co">#' @param sim_list Simulation configuration list</span></span>
<span><span class="co">#' @param n_cores Number of CPU cores to use </span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return List of simulation results for each management procedure</span></span>
<span><span class="va">run_parallel_simulations</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mp_list</span>, <span class="va">sim_list</span>, <span class="va">n_cores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Initialize parallel cluster</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># load in packages</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chengmatt.github.io/SPoRC">SPoRC</a></span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># export functions in env</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span></span>
<span>    <span class="va">cl</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sim_list"</span>, <span class="st">"assessment_years"</span>, <span class="st">"years_to_use"</span>, <span class="st">"assess_freq"</span>,</span>
<span>      <span class="st">"setup_em"</span>, <span class="st">"run_projection"</span>, <span class="st">"apply_catch_constraints"</span>,</span>
<span>      <span class="st">"tac_to_fmort"</span>, <span class="st">"run_single_replicate"</span><span class="op">)</span>,</span>
<span>    envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># init results storage</span></span>
<span>  <span class="va">sim_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># loop through each management procedure</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"Running MP %d/%d: %s on %d cores with %d replicates"</span>,</span>
<span>      <span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">n_cores</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># export MP to par env</span></span>
<span>    <span class="va">current_mp_config</span> <span class="op">&lt;-</span> <span class="va">mp_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">current_mp_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"current_mp_config"</span>, <span class="st">"current_mp_name"</span><span class="op">)</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># run replicates in parallel</span></span>
<span>    <span class="va">replicate_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span>, <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span> <span class="op">+</span> <span class="va">sim</span><span class="op">)</span> </span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>        <span class="fu">run_single_replicate</span><span class="op">(</span></span>
<span>          sim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>          sim_list <span class="op">=</span> <span class="va">sim_list</span>,</span>
<span>          mp_config <span class="op">=</span> <span class="va">current_mp_config</span>,</span>
<span>          assessment_years <span class="op">=</span> <span class="va">assessment_years</span>,</span>
<span>          years_to_use <span class="op">=</span> <span class="va">years_to_use</span>,</span>
<span>          assess_freq <span class="op">=</span> <span class="va">assess_freq</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, sim <span class="op">=</span> <span class="va">sim</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># get dimensions from first replicate</span></span>
<span>    <span class="va">n_regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">replicate_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ssb</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">n_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">replicate_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ssb</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">n_ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">replicate_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">naa</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">n_sexes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">replicate_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">naa</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>    <span class="va">n_fish_fleets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">replicate_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fmort</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># init result arrays</span></span>
<span>    <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      mp_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mp_list</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      rec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      ssb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span>, <span class="va">n_fish_fleets</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      fmort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span>, <span class="va">n_fish_fleets</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      naa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span>, <span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># populate result arrays from replicate results</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_list</span><span class="op">$</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rec</span><span class="op">[</span>, , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">replicate_results</span><span class="op">[[</span><span class="va">sim</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rec</span></span>
<span>      <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ssb</span><span class="op">[</span>, , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">replicate_results</span><span class="op">[[</span><span class="va">sim</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ssb</span></span>
<span>      <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">catch</span><span class="op">[</span>, , , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">replicate_results</span><span class="op">[[</span><span class="va">sim</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">catch</span></span>
<span>      <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fmort</span><span class="op">[</span>, , , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">replicate_results</span><span class="op">[[</span><span class="va">sim</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fmort</span></span>
<span>      <span class="va">sim_res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">naa</span><span class="op">[</span>, , , , <span class="va">sim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">replicate_results</span><span class="op">[[</span><span class="va">sim</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">naa</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># reset parallel cluster</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="condition-closed-loop-simulation">Condition Closed Loop Simulation<a class="anchor" aria-label="anchor" href="#condition-closed-loop-simulation"></a>
</h2>
<p>Before running full closed-loop projections, we first condition the
simulation to be based on historical dynamics estimated from the Gulf of
Alaska Dusky Rockfish assessment. Two demographic scenarios are used to
condition future recruitment dynamics in this simulation, which include
the <code>rand</code> and <code>crash</code> scenarios. In the
<code>rand</code> scenario, recruitment is resampled from the input data
to reflect natural variability in year-to-year recruitment. This
generates multiple stochastic replicates that maintain historical
patterns while incorporating random variability. By contrast, the
<code>crash</code> scenario simulates future recruitment to mimic a
population that crashes, followed by recovery The inputs
<code>R0_input</code> and <code>h_input</code> are set to produce a
period of low recruitment (crash) and a subsequent rebound, providing a
scenario to test management procedure performance under extreme
population dynamics. The assessment is conducted at a regular frequency
(<code>assess_freq</code>; 2 years) after the burn-in period, and data
are available at specified intervals (<code>data_yr_freq</code>; 2
years),</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract model components from dusky model</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">rep</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">rep</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">parameters</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">mapping</span></span>
<span><span class="va">sd_rep</span> <span class="op">&lt;-</span> <span class="va">dusky_rtmb_model</span><span class="op">$</span><span class="va">sdrep</span></span>
<span></span>
<span><span class="co"># Define operating model parameters</span></span>
<span><span class="va">closed_loop_yrs</span> <span class="op">&lt;-</span> <span class="fl">50</span>      <span class="co"># Years to project forward</span></span>
<span><span class="va">n_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>  <span class="co"># number of years</span></span>
<span><span class="va">burnin_years</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>  <span class="co"># Historical conditioning period</span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">200</span>              <span class="co"># Number of replicate simulations</span></span>
<span><span class="va">assess_freq</span> <span class="op">&lt;-</span> <span class="fl">2</span>           <span class="co"># Assessment frequency (every 3 years)</span></span>
<span><span class="va">data_yr_freq</span> <span class="op">&lt;-</span> <span class="fl">2</span>          <span class="co"># Data collection frequency</span></span>
<span><span class="va">n_regions</span> <span class="op">&lt;-</span> <span class="fl">1</span>            <span class="co"># number of regions</span></span>
<span></span>
<span><span class="co"># Condition closed-loop simulations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># random recruitment</span></span>
<span><span class="va">sim_list_rand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condition_closed_loop_simulations.html">condition_closed_loop_simulations</a></span><span class="op">(</span></span>
<span>  closed_loop_yrs <span class="op">=</span> <span class="va">closed_loop_yrs</span>,</span>
<span>  n_sims <span class="op">=</span> <span class="va">n_sims</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>  sd_rep <span class="op">=</span> <span class="va">sd_rep</span>,</span>
<span>  rep <span class="op">=</span> <span class="va">rep</span>,</span>
<span>  random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  recruitment_opt <span class="op">=</span> <span class="st">'resample_from_input'</span>,</span>
<span>  ISS_FishAgeComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span>,</span>
<span>  ISS_FishLenComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># beverton holt crash and recover</span></span>
<span><span class="co"># setup R0 input to mimic crash scenario</span></span>
<span><span class="va">R0_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span> <span class="op">+</span> <span class="va">closed_loop_yrs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">R0_input</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">47</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">ln_global_R0</span><span class="op">)</span> <span class="co"># mean recruitment from EM</span></span>
<span><span class="va">R0_input</span><span class="op">[</span>,<span class="fl">48</span><span class="op">:</span><span class="fl">70</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2.5</span> <span class="co"># BH recruitment with crash R0</span></span>
<span><span class="va">R0_input</span><span class="op">[</span>,<span class="fl">71</span><span class="op">:</span><span class="fl">98</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># BH recruitment with rebound R0</span></span>
<span><span class="va">R0_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_sims</span>, <span class="va">R0_input</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># setup h input to mimic crash scenario</span></span>
<span><span class="va">h_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_years</span> <span class="op">+</span> <span class="va">closed_loop_yrs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">h_input</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">47</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.999</span> <span class="co"># mean recruitment from EM</span></span>
<span><span class="va">h_input</span><span class="op">[</span>,<span class="fl">48</span><span class="op">:</span><span class="fl">70</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># steepness in crash</span></span>
<span><span class="va">h_input</span><span class="op">[</span>,<span class="fl">71</span><span class="op">:</span><span class="fl">98</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.75</span> <span class="co"># steepness in rebound</span></span>
<span><span class="va">h_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_sims</span>, <span class="va">h_input</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_list_crash</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condition_closed_loop_simulations.html">condition_closed_loop_simulations</a></span><span class="op">(</span></span>
<span>  closed_loop_yrs <span class="op">=</span> <span class="va">closed_loop_yrs</span>,</span>
<span>  n_sims <span class="op">=</span> <span class="va">n_sims</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>  sd_rep <span class="op">=</span> <span class="va">sd_rep</span>,</span>
<span>  rep <span class="op">=</span> <span class="va">rep</span>,</span>
<span>  random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  recruitment_opt <span class="op">=</span> <span class="st">'bh_rec'</span>,</span>
<span>  ISS_FishAgeComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span>,</span>
<span>  ISS_FishLenComps_fill <span class="op">=</span> <span class="st">"F_pattern"</span>,</span>
<span>  R0_input <span class="op">=</span> <span class="va">R0_input</span>,</span>
<span>  h_input <span class="op">=</span> <span class="va">h_input</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define assessment and data years</span></span>
<span><span class="va">assessment_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sim_list_rand</span><span class="op">$</span><span class="va">feedback_start_yr</span>, <span class="va">sim_list_rand</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">assess_freq</span><span class="op">)</span></span>
<span><span class="va">years_to_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">burnin_years</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">sim_list_rand</span><span class="op">$</span><span class="va">feedback_start_yr</span>, <span class="va">sim_list_rand</span><span class="op">$</span><span class="va">n_yrs</span>, <span class="va">data_yr_freq</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-simulations">Run Simulations<a class="anchor" aria-label="anchor" href="#run-simulations"></a>
</h2>
<p>With the simulation environments conditioned, we can now run the
closed-loop projections for each management procedure and scenario.
Results from both scenarios are combined into a single object
(<code>sim_all</code>) for subsequent analysis and comparison of MP
performance.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_res_rand</span> <span class="op">&lt;-</span> <span class="fu">run_parallel_simulations</span><span class="op">(</span><span class="va">mp_list</span>, <span class="va">sim_list_rand</span>, n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">sim_res_crash</span> <span class="op">&lt;-</span> <span class="fu">run_parallel_simulations</span><span class="op">(</span><span class="va">mp_list</span>, <span class="va">sim_list_crash</span>, n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">sim_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rand <span class="op">=</span> <span class="va">sim_res_rand</span>, crash <span class="op">=</span> <span class="va">sim_res_crash</span><span class="op">)</span> <span class="co"># combine scenarios</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="process-results">Process Results<a class="anchor" aria-label="anchor" href="#process-results"></a>
</h2>
<p>After simulations have been performed, we can extract results and
summarize them for visualization. Below, we extract spawning stock
biomass, recruitment, catch, fishing mortality rates. We then summarize
these quantities across their time-series (and within each time point)
as the median and their associated 95% simulation intervals.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process results</span></span>
<span><span class="va">ssb_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rec_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">catch_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">f_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim_all</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># extract out recruitment scenario</span></span>
<span>  <span class="va">sim_tmp</span> <span class="op">&lt;-</span> <span class="va">sim_all</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># get mp specific results</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim_tmp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># get ssb</span></span>
<span>    <span class="va">tmp_ssb</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ssb</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Sim <span class="op">=</span> <span class="va">Var3</span>, SSB <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>MP <span class="op">=</span> <span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mp_name</span>,</span>
<span>             Scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sim_all</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># get rec</span></span>
<span>    <span class="va">tmp_rec</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Sim <span class="op">=</span> <span class="va">Var3</span>, Rec <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>MP <span class="op">=</span> <span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mp_name</span>,</span>
<span>             Scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sim_all</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># get catch</span></span>
<span>    <span class="va">tmp_catch</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">catch</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Fleet <span class="op">=</span> <span class="va">Var3</span>, Sim <span class="op">=</span> <span class="va">Var4</span>, cat <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>MP <span class="op">=</span> <span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mp_name</span>,</span>
<span>             Scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sim_all</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># get f</span></span>
<span>    <span class="va">tmp_f</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fmort</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span>, Fleet <span class="op">=</span> <span class="va">Var3</span>, Sim <span class="op">=</span> <span class="va">Var4</span>, f <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>MP <span class="op">=</span> <span class="va">sim_tmp</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mp_name</span>,</span>
<span>             Scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sim_all</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">ssb_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">ssb_results</span>, <span class="va">tmp_ssb</span><span class="op">)</span></span>
<span>    <span class="va">rec_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rec_results</span>, <span class="va">tmp_rec</span><span class="op">)</span></span>
<span>    <span class="va">catch_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">catch_results</span>, <span class="va">tmp_catch</span><span class="op">)</span></span>
<span>    <span class="va">f_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">f_results</span>, <span class="va">tmp_f</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># get summary statistics for time series</span></span>
<span><span class="va">sumry</span> <span class="op">&lt;-</span> <span class="va">ssb_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># ssb</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Year</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">SSB</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Spawning Stock Biomass'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">catch_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># catch</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Year</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span>,</span>
<span>                lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cat</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>                upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cat</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Catch'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">f_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># fishing mortality</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Year</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>,</span>
<span>                lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">f</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>                upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">f</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Fishing Mortality'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">rec_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># recruitment</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Year</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">Rec</span><span class="op">)</span>,</span>
<span>                lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Rec</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>                upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Rec</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Recruitment'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Year</span> <span class="op">+</span> <span class="fl">1976</span>,</span>
<span>         Period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&lt;=</span> <span class="fl">2024</span>, <span class="st">"Historical"</span>, <span class="st">"Feedback"</span><span class="op">)</span>,</span>
<span>         MP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">MP</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"f0"</span>, <span class="st">"f40_thresh"</span>, <span class="st">"f40_const"</span>, <span class="st">"f40_steep"</span>,</span>
<span>                                    <span class="st">"f40_thresh_cap"</span>, <span class="st">"f40_hybrid"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Scenario</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rand"</span>, <span class="st">"crash"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate summary statistics across entire feedback period from raw data</span></span>
<span><span class="va">period_summary</span> <span class="op">&lt;-</span> <span class="va">ssb_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span> <span class="op">-</span> <span class="fl">1976</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># feedback period (Year is relative to 1976)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">SSB</span><span class="op">)</span>,</span>
<span>    lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Spawning Stock Biomass'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">catch_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span> <span class="op">-</span> <span class="fl">1976</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Scenario</span>, <span class="va">Sim</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        catch_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        aav <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">catch_mean</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="op">(</span><span class="va">cat</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">catch_mean</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">aav</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">aav</span>, <span class="fl">0.025</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">aav</span>, <span class="fl">0.975</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'AAV'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">rec_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span> <span class="op">-</span> <span class="fl">1976</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">Rec</span><span class="op">)</span>,</span>
<span>        lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Rec</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>        upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Rec</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>        .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Recruitment'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">catch_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span> <span class="op">-</span> <span class="fl">1976</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">Scenario</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span>,</span>
<span>        lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cat</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>        upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cat</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>        .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Catch'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>MP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">MP</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"f0"</span>, <span class="st">"f40_thresh"</span>, <span class="st">"f40_const"</span>, <span class="st">"f40_steep"</span>,</span>
<span>                                    <span class="st">"f40_thresh_cap"</span>, <span class="st">"f40_hybrid"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize">Visualize<a class="anchor" aria-label="anchor" href="#visualize"></a>
</h2>
<p>We can visualize results using line and radar plots. Across MPs,
trade-offs are apparent: under the <code>rand</code> recruitment
scenario, catch remained stable, with lower harvest for capped MPs
(<strong>f40_thresh_cap</strong>, <strong>f40_hybrid</strong>) and
higher harvest for uncapped MPs. Spawning stock biomass was higher where
harvest was lower, and catch AAV was lowest for capped MPs. Under the
<code>crash</code> scenario, differences became larger: MPs with higher
biomass reference points (e.g., <strong>f40_steep</strong>) reduced
catch early, maintaining higher SSB (but at the cost of increased catch
variability), while <strong>f40_const</strong> allowed higher catch
during low recruitment but lower catch after recovery. Overall,
<strong>f40_thresh_cap</strong> and <strong>f40_hybrid</strong> offered
balanced trade-offs, supporting intermediate catch, improved spawning
stock biomass, and reduced catch variability.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span> <span class="co"># colors</span></span>
<span></span>
<span><span class="co"># plot time series</span></span>
<span><span class="va">lineplot_with_legend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="va">sumry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span>, <span class="op">!</span><span class="va">Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Fishing Mortality'</span>, <span class="st">"Recruitment"</span><span class="op">)</span>, <span class="va">MP</span> <span class="op">==</span> <span class="st">'f40_thresh'</span><span class="op">)</span>,</span>
<span>              mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">sumry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Fishing Mortality'</span>, <span class="st">"Recruitment"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span>, color <span class="op">=</span> <span class="va">MP</span>, linetype <span class="op">=</span> <span class="va">MP</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">sumry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&lt;</span> <span class="fl">2025</span>, <span class="op">!</span><span class="va">Type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Fishing Mortality'</span>, <span class="st">"Recruitment"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">median</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.1</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2024.5</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggh4x</span><span class="fu">::</span><span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/facet_grid2.html" class="external-link">facet_grid2</a></span><span class="op">(</span><span class="va">Scenario</span> <span class="op">~</span> <span class="va">Type</span>, scales <span class="op">=</span> <span class="st">"free"</span>, independent <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">17</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.09</span>, <span class="fl">0.875</span><span class="op">)</span>,</span>
<span>        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># show it for extraction</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year"</span>, y <span class="op">=</span> <span class="st">"Median Value"</span>, color <span class="op">=</span> <span class="st">"Management Procedure"</span>, lty <span class="op">=</span> <span class="st">"Management Procedure"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># radar plot for crash scenario</span></span>
<span><span class="va">radar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggradar/man/ggradar-package.html" class="external-link">ggradar</a></span><span class="op">(</span></span>
<span>  <span class="va">period_summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Scenario</span> <span class="op">==</span> <span class="st">'crash'</span>, <span class="va">Type</span> <span class="op">!=</span> <span class="st">'Recruitment'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Type</span> <span class="op">==</span> <span class="st">'AAV'</span>, <span class="va">median</span> <span class="op">+</span> <span class="fl">1e-5</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">MP</span>,<span class="va">median</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Type</span> <span class="op">==</span> <span class="st">'AAV'</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">median</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># Flip AAV</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">'Type'</span>, id_cols <span class="op">=</span> <span class="st">'MP'</span>, values_from <span class="op">=</span> <span class="st">'median'</span><span class="op">)</span>,</span>
<span>  line.alpha <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>  axis.label.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  point.alpha <span class="op">=</span> <span class="fl">0.55</span>,</span>
<span>  group.point.size <span class="op">=</span> <span class="fl">4.5</span>,</span>
<span>  background.circle.colour <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  background.circle.transparency <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  axis.line.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.min.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.mid.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.max.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  group.colours <span class="op">=</span> <span class="va">cols</span>,</span>
<span>  legend.position <span class="op">=</span> <span class="st">'none'</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># radar plot for random recruitment scenario</span></span>
<span><span class="va">radar2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggradar/man/ggradar-package.html" class="external-link">ggradar</a></span><span class="op">(</span></span>
<span>  <span class="va">period_summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Scenario</span> <span class="op">==</span> <span class="st">'rand'</span>, <span class="va">Type</span> <span class="op">!=</span> <span class="st">'Recruitment'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Type</span> <span class="op">==</span> <span class="st">'AAV'</span>, <span class="va">median</span> <span class="op">+</span> <span class="fl">1e-5</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">MP</span>, <span class="va">median</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Type</span> <span class="op">==</span> <span class="st">'AAV'</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">median</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">'Type'</span>, id_cols <span class="op">=</span> <span class="st">'MP'</span>, values_from <span class="op">=</span> <span class="st">'median'</span><span class="op">)</span>,</span>
<span>  line.alpha <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>  axis.label.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  point.alpha <span class="op">=</span> <span class="fl">0.55</span>,</span>
<span>  group.point.size <span class="op">=</span> <span class="fl">4.5</span>,</span>
<span>  background.circle.colour <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  background.circle.transparency <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  axis.line.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.min.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.mid.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  gridline.max.colour <span class="op">=</span> <span class="st">"gray60"</span>,</span>
<span>  group.colours <span class="op">=</span> <span class="va">cols</span>,</span>
<span>  legend.position <span class="op">=</span> <span class="st">'none'</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">radar_combo</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">radar2</span>, <span class="va">radar1</span>, ncol <span class="op">=</span> <span class="fl">1</span>, labels <span class="op">=</span> <span class="st">'B'</span>, label_size <span class="op">=</span> <span class="fl">30</span>, label_x <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">main_plot</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">lineplot_with_legend</span>, <span class="va">radar_combo</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">0.25</span><span class="op">)</span>, labels <span class="op">=</span> <span class="st">'A'</span>, label_size <span class="op">=</span> <span class="fl">30</span>, label_x <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">main_plot</span></span></code></pre></div>
<p><img src="figures/p_dusky_closed_loop.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Cheng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
