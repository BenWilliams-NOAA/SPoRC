<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running a Simple Assessment (The Basics) • SPoRC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running a Simple Assessment (The Basics)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SPoRC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Running a Simple Assessment (The Basics)</h1>
            
      

      <div class="d-none name"><code>o_get_started.Rmd</code></div>
    </div>

    
    
<p>This vignette provides an end-to-end example of implementing a stock
assessment model using the 2024 Gulf of Alaska (GOA) Dusky Rockfish
assessment as a case study. We show how to set up a simple stock
assessment model, evaluate alternative model configurations, conduct
standard diagnostics, and use model projections to develop catch advice
for future years. The GOA Dusky Rockfish Model is formulated as a
single-area, single-sex, age-structured model with one fishery and one
survey fleet. It spans the years 1977–2024, includes 33 modeled ages,
and assumes a fixed natural mortality rate. Both fishery and survey
selectivity follow a logistic, time-invariant form. Catch advice is
based on spawning potential ratio reference points, targeting a
population level corresponding to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{40\%}</annotation></semantics></math>.
First, let us load in any necessary packages as well as data files. The
Dusky Rockfish data file is provided within the <code>SPoRC</code>
package and is called <code>sgl_rg_dusky_data</code>.</p>
<div class="section level2">
<h2 id="load-data-and-packages">Load data and packages<a class="anchor" aria-label="anchor" href="#load-data-and-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chengmatt.github.io/SPoRC">SPoRC</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"sgl_rg_dusky_data"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup-model">Setup model<a class="anchor" aria-label="anchor" href="#setup-model"></a>
</h2>
<p>To initially setup the model, an input list composed of a data list,
parameter list, and mapping list is required. This setup is facilitated
by the function <code>Setup_Mod_Dim</code>, where users define vectors
of years, ages, and lengths. Users must also specify the number of
modeled regions (<code>n_regions</code>), sexes (<code>n_sexes</code>),
fishery fleets (<code>n_fish_fleets</code>), and survey fleets
(<code>n_srv_fleets</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Dim.html">Setup_Mod_Dim</a></span><span class="op">(</span></span>
<span>  years <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">years</span>,</span>
<span>  <span class="co"># vector of years</span></span>
<span>  ages <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">mod_ages</span>,</span>
<span>  <span class="co"># vector of ages</span></span>
<span>  lens <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">lens</span>,</span>
<span>  <span class="co"># number of lengths</span></span>
<span>  n_regions <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>  <span class="co"># number of regions</span></span>
<span>  n_sexes <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>  <span class="co"># number of sexes</span></span>
<span>  n_fish_fleets <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_fish_fleets</span>,</span>
<span>  <span class="co"># number of fishery fleets</span></span>
<span>  n_srv_fleets <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_srv_fleets</span>, <span class="co"># number of survey fleets</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># whether to output messages</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="setup-recruitment-dynamics">Setup Recruitment Dynamics<a class="anchor" aria-label="anchor" href="#setup-recruitment-dynamics"></a>
</h3>
<p>After initializing the <code>input_list</code>, the object is passed
to the next function, <code>Setup_Mod_Rec</code>, to define recruitment
dynamics. For the GOA Dusky Rockfish model, recruitment is specified as
follows:</p>
<ol style="list-style-type: decimal">
<li>Mean recruitment is estimated,</li>
<li>No lognormal bias correction is applied, which is achieved by
setting all bias ramp values to 0 (and turning on the bias ramp),</li>
<li>Recruitment variability is fixed,</li>
<li>Spawning is assumed to occur at the start of the year.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Rec.html">Setup_Mod_Rec</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  <span class="co"># Doing bias ramp, but basically setting it so that no lognormal bias correction happens (as in the dusky model)</span></span>
<span>  do_rec_bias_ramp <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  bias_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="co"># do bias ramp (0 == don't do bias ramp, 1 == do bias ramp)</span></span>
<span>  sigmaR_switch <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># when to switch from early to late sigmaR (switch in first year)</span></span>
<span>  ln_sigmaR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1068576</span> , <span class="fl">2</span><span class="op">)</span>, <span class="co"># 2 values for early and late sigma</span></span>
<span>  <span class="co"># Starting values for early and late sigmaR</span></span>
<span>  rec_model <span class="op">=</span> <span class="st">"mean_rec"</span>,</span>
<span>  sigmaR_spec <span class="op">=</span> <span class="st">"fix"</span>,</span>
<span>  <span class="co"># fix early sigmaR and late sigmaR</span></span>
<span>  init_age_strc <span class="op">=</span> <span class="fl">1</span>, <span class="co"># geometric series to derive initial age structure</span></span>
<span>  ln_global_R0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.7</span><span class="op">)</span>, <span class="co"># starting value for mean_rec</span></span>
<span>  t_spawn <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">spwn_month</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-biological-dynamics">Setup biological dynamics<a class="anchor" aria-label="anchor" href="#setup-biological-dynamics"></a>
</h3>
<p>With the updated input_list from the previous step, the next stage is
to parameterize the model’s biological dynamics. The function
<code>Setup_Mod_Biologicals</code> requires weight-at-age
(<code>WAA</code>) and maturity-at-age (<code>MatAA</code>) inputs, each
dimensioned by <code>n_regions</code>, <code>n_years</code>,
<code>n_ages</code>, and <code>n_sexes.</code> In this case, natural
mortality is assumed to be constant and fixed at 0.07.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Biologicals.html">Setup_Mod_Biologicals</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># Data inputs</span></span>
<span>  WAA <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">waa_arr</span>, <span class="co"># weight at age array</span></span>
<span>  MatAA <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">mataa_arr</span>, <span class="co"># maturity at age array</span></span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  <span class="co"># fit lengths</span></span>
<span>  fit_lengths <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  SizeAgeTrans <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">sizeage</span>, <span class="co"># size age transition</span></span>
<span>  AgeingError <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">age_error_matrix</span>, <span class="co"># ageing error matrix</span></span>
<span>  M_spec <span class="op">=</span> <span class="st">"fix"</span>,</span>
<span>  <span class="co"># fixing natural mortality</span></span>
<span>  Fixed_natmort <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">fix_natmort</span>,</span>
<span>  addtocomp <span class="op">=</span> <span class="fl">0.00001</span> <span class="co"># adding small constant to compositions</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-movement-and-tagging">Setup Movement and Tagging<a class="anchor" aria-label="anchor" href="#setup-movement-and-tagging"></a>
</h3>
<p>Because this vignette illustrates a single-region model, movement
dynamics are not included. However, users must specify how movement is
parameterized. In this example, movement is not estimated
(<code>use_fixed_movement = 1</code>), the movement matrix is set to
identity (<code>Fixed_Movement = NA</code>), and recruits are assumed
not to move (<code>do_recruits_move = 0</code>). Tagging dynamics are
defined similarly: the <code>input_list</code> is updated and the
<code>UseTagging</code> argument is set to 0.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setup movement</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Movement.html">Setup_Mod_Movement</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>    use_fixed_movement <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    Fixed_Movement <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    do_recruits_move <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># setup tagging</span></span>
<span>  <span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Tagging.html">Setup_Mod_Tagging</a></span><span class="op">(</span></span>
<span>    input_list <span class="op">=</span> <span class="va">input_list</span>, </span>
<span>    UseTagging <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-catch-and-fishing-mortality">Setup Catch and Fishing Mortality<a class="anchor" aria-label="anchor" href="#setup-catch-and-fishing-mortality"></a>
</h3>
<p>The function <code>Setup_Mod_Catch_and_F</code> then updates the
<code>input_list</code> with catch data and fishing mortality
specifications. Three data inputs are required: observed catch
(<code>ObsCatch</code>), the type of catch (<code>Catch_Type</code>),
and an indicator for whether the catch is used in the model
(<code>UseCatch</code>). Model options include a switch for applying a
fishing mortality penalty (<code>Use_F_pen</code>) and whether the catch
error standard deviation is fixed or estimated
(<code>sigmaC_spec</code>), and a small constant added to avoid problems
with zero catches (<code>Catch_Constant</code>). Finally, fixed values
for the observation error of catch (<code>ln_sigmaC</code>) and the
penalty on fishing mortality (<code>ln_sigmaF</code>) are provided. Note
that these are specified as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msqrt><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mi>/</mi><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></msqrt><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(\sqrt{(1/2)})</annotation></semantics></math>
because the model was originally written in ADMB where these values were
computed as sum of squares, and the standard deviation of these terms
were implicitly assumed to be set at 1.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Catch_and_F.html">Setup_Mod_Catch_and_F</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># Data inputs</span></span>
<span>  ObsCatch <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsCatch</span>, <span class="co"># observed catch</span></span>
<span>  Catch_Type <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">Catch_Type</span>, <span class="co"># catch type</span></span>
<span>  UseCatch <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseCatch</span>, <span class="co"># whether catch is used</span></span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  Use_F_pen <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># whether to use f penalty, == 0 don't use, == 1 use</span></span>
<span>  sigmaC_spec <span class="op">=</span> <span class="st">"fix"</span>,</span>
<span></span>
<span>  <span class="co"># Fixing sigma C and F</span></span>
<span>  ln_sigmaC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  ln_sigmaF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-fishery-indices-and-compositions">Setup Fishery Indices and Compositions<a class="anchor" aria-label="anchor" href="#setup-fishery-indices-and-compositions"></a>
</h3>
<p>Next, the function <code>Setup_Mod_FishIdx_and_Comps</code> updates
the <code>input_list</code> with fishery index and composition data.
Inputs include observed fishery indices with associated standard errors,
indicators for whether each index is used, and observed age and length
compositions with corresponding use flags and input sample sizes. Model
options then define how these data are treated: in this case, no fishery
index is applied (<code>fish_idx_type = "none"</code>), both age and
length compositions are modeled with multinomial likelihoods, and the
composition structures are specified as
<code>agg_Year_1-terminal_Fleet_1</code> (for any single region, single
sex model, composition structures should be specified as such, wherein
these data are aggregated across model partitions).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_FishIdx_and_Comps.html">Setup_Mod_FishIdx_and_Comps</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># data inputs</span></span>
<span>  ObsFishIdx <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsFishIdx</span>, <span class="co"># fishery index</span></span>
<span>  ObsFishIdx_SE <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsFishIdx_SE</span>, <span class="co"># standard errors</span></span>
<span>  UseFishIdx <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseFishIdx</span>, <span class="co"># whether fishery indices are used</span></span>
<span>  ObsFishAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsFishAgeComps</span>, <span class="co"># observed fishery ages</span></span>
<span>  UseFishAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span>, <span class="co"># whether fishery ages are used</span></span>
<span>  ISS_FishAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ISS_FishAgeComps</span>, <span class="co"># input sample size for fishery ages</span></span>
<span>  ObsFishLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsFishLenComps</span>, <span class="co"># observed fishery lengths</span></span>
<span>  UseFishLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseFishLenComps</span>, <span class="co"># whether fishery lengths are used</span></span>
<span>  ISS_FishLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ISS_FishLenComps</span>, <span class="co"># input sample size for fishery lengths</span></span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  fish_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>,</span>
<span>  <span class="co"># indices for fishery</span></span>
<span>  FishAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>  <span class="co"># age comp likelihoods for fishery fleet</span></span>
<span>  FishLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>  <span class="co"># length comp likelihoods for fishery</span></span>
<span>  FishAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># age comp structure for fishery</span></span>
<span>  FishLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_Year_1-terminal_Fleet_1"</span><span class="op">)</span></span>
<span>  <span class="co"># length comp structure for fishery</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-survey-indices-and-compositions">Setup Survey Indices and Compositions<a class="anchor" aria-label="anchor" href="#setup-survey-indices-and-compositions"></a>
</h3>
<p>The <code>Setup_Mod_SrvIdx_and_Comps</code> function is defined
similar to the previous code chunk, but instead, updates the
<code>input_list</code> with survey indices and composition data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_SrvIdx_and_Comps.html">Setup_Mod_SrvIdx_and_Comps</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># data inputs</span></span>
<span>  ObsSrvIdx <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsSrvIdx</span>, <span class="co"># observed survey index</span></span>
<span>  ObsSrvIdx_SE <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsSrvIdx_SE</span> <span class="op">/</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsSrvIdx</span>, <span class="co"># lognormal SD</span></span>
<span>  UseSrvIdx <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseSrvIdx</span>, <span class="co"># whether survey indices are used</span></span>
<span>  ObsSrvAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsSrvAgeComps</span>, <span class="co"># observed survey ages</span></span>
<span>  ISS_SrvAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ISS_SrvAgeComps</span>, <span class="co"># input sample size for survey ages</span></span>
<span>  UseSrvAgeComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span>, <span class="co"># whether survey ages are used</span></span>
<span>  ObsSrvLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ObsSrvLenComps</span>, <span class="co"># observed survey lengths</span></span>
<span>  UseSrvLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">UseSrvLenComps</span>, <span class="co"># whether survey lengths are used</span></span>
<span>  ISS_SrvLenComps <span class="op">=</span> <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">ISS_SrvLenComps</span>, <span class="co"># input sample size for survey lengths</span></span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  srv_idx_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biom"</span><span class="op">)</span>,</span>
<span>  <span class="co"># abundance and biomass for survey fleet 1</span></span>
<span>  SrvAgeComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>  <span class="co"># survey age composition likelihood for survey fleet 1</span></span>
<span>  SrvLenComps_LikeType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Multinomial"</span><span class="op">)</span>,</span>
<span>  <span class="co">#  survey length composition likelihood for survey fleet 1</span></span>
<span>  SrvAgeComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"agg_Year_1-terminal_Fleet_1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># survey age comp type</span></span>
<span></span>
<span>  SrvLenComps_Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"agg_Year_1-terminal_Fleet_1"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># survey length comp type</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-fishery-selectivity-and-catchability">Setup Fishery Selectivity and Catchability<a class="anchor" aria-label="anchor" href="#setup-fishery-selectivity-and-catchability"></a>
</h3>
<p>Following defining the data inputs into the model, we can specify the
fishery selectivity and catchability parameterizations. Here, no
time-varying selectivity is specified, and selectivity is modelled as
logistic with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>50</mn></msub><annotation encoding="application/x-tex">b_{50}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>95</mn></msub><annotation encoding="application/x-tex">b_{95}</annotation></semantics></math>.
Catchability is fixed because no fishery indices are included in the
model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Fishsel_and_Q.html">Setup_Mod_Fishsel_and_Q</a></span><span class="op">(</span></span>
<span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  <span class="co"># fishery selectivity, whether continuous time-varying</span></span>
<span>  cont_tv_fish_sel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># fishery selectivity blocks</span></span>
<span>  fish_sel_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># fishery selectivity form</span></span>
<span>  fish_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># fishery catchability blocks</span></span>
<span>  fish_q_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># whether to estiamte all fixed effects for fishery selectivity</span></span>
<span>  fish_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>  <span class="co"># whether to estiamte all fixed effects for fishery catchability</span></span>
<span>  fish_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fix"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-survey-selectivity-and-catchability">Setup Survey Selectivity and Catchability<a class="anchor" aria-label="anchor" href="#setup-survey-selectivity-and-catchability"></a>
</h3>
<p>Similar to the <code>Setup_Mod_Fishsel_and_Q</code> function, we can
define the survey selectivity and catchability parameterizations. Again,
no time-vaying selectivity is specified, and selectivity is modelled as
logistic with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>50</mn></msub><annotation encoding="application/x-tex">b_{50}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>95</mn></msub><annotation encoding="application/x-tex">b_{95}</annotation></semantics></math>.
However, catchabiltiy is estiamted with a estimated for the survey
index. Note that the survey prior specifications must be passed into the
function as a dataframe with column names: <code>region</code>,
<code>block</code>, <code>fleet</code>, <code>mu</code>, and
<code>sd.</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Set up prior for survey catchability</span></span>
<span><span class="va">srv_q_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  region <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  block <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  fleet <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  mu <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">0.447213595</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Srvsel_and_Q.html">Setup_Mod_Srvsel_and_Q</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span></span>
<span>  <span class="co"># Model options</span></span>
<span>  <span class="co"># survey selectivity, whether continuous time-varying</span></span>
<span>  cont_tv_srv_sel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># survey selectivity blocks</span></span>
<span>  srv_sel_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># survey selectivity form</span></span>
<span>  srv_sel_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logist2_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># survey catchability blocks</span></span>
<span>  srv_q_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none_Fleet_1"</span><span class="op">)</span>,</span>
<span>  <span class="co"># whether to estiamte all fixed effects for survey selectivity</span></span>
<span>  srv_fixed_sel_pars_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>  <span class="co"># whether to estiamte all fixed effects for survey catchability</span></span>
<span>  srv_q_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_all"</span><span class="op">)</span>,</span>
<span>  Use_srv_q_prior <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># Use catchability prior</span></span>
<span>  srv_q_prior <span class="op">=</span> <span class="va">srv_q_prior</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-model-weighting">Setup Model Weighting<a class="anchor" aria-label="anchor" href="#setup-model-weighting"></a>
</h3>
<p>Finally, the model weighting scheme can be defined to control the
relative influence of different data sources on the assessment. In the
GOA Dusky Rockfish model, weighting is applied using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
emphasis factors, which allow certain data types to have more or less
influence on model fitting. If users prefer not to apply differential
weighting, all values can be set to 1. For catch data, a different
weighting scheme is applied for the early years of the model: catches
from 1977–1991 are given a weight of 2, while catches in later years are
assigned a higher weight of 50.</p>
<p>The weighting setup is implemented using the function
<code>Setup_Mod_Weighting</code>, which accepts the constructed
input_list along with specific weights for various data components.
Here, catch weights are defined as described above, fishery indices are
given a weight of <code>1</code>, survey indices a weight of
<code>1.66</code>, recruitment a weight of <code>1</code>, and fishing
mortality a weight of <code>2.</code> Tagging data are not used, so its
weight is set to <code>0.</code> Age and length compositions for both
fishery and survey fleets are assigned arrays of weights, typically set
to 1 for fishery data and survey ages, while survey length compositions
are set to 0.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># catch weigthing </span></span>
<span><span class="va">Wt_Catch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Wt_Catch</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">years</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1977</span><span class="op">:</span><span class="fl">1991</span><span class="op">)</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">Wt_Catch</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">sgl_rg_dusky_data</span><span class="op">$</span><span class="va">years</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1977</span><span class="op">:</span><span class="fl">1991</span><span class="op">)</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Setup_Mod_Weighting.html">Setup_Mod_Weighting</a></span><span class="op">(</span></span>
<span>  input_list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>  Wt_Catch <span class="op">=</span> <span class="va">Wt_Catch</span>,</span>
<span>  Wt_FishIdx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  Wt_SrvIdx <span class="op">=</span> <span class="fl">1.66</span>,</span>
<span>  Wt_Rec <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  Wt_F <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  Wt_Tagging <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  Wt_FishAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                     <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>                                     <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Wt_FishLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                     <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>                                     <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Wt_SrvAgeComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                    <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>                                    <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Wt_SrvLenComps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>                                    <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_sexes</span>,</span>
<span>                                    <span class="va">input_list</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_srv_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="fit-model">Fit model<a class="anchor" aria-label="anchor" href="#fit-model"></a>
</h2>
<p>Once the model has been fully defined, it can be fitted to the data.
In this example, we will fit two models. The first model uses the setup
described above without any additional weighting adjustments. The second
model applies Francis re-weighting to the same base model. This approach
serves to illustrate how to compare alternative model configurations and
demonstrates the implementation of Francis re-weighting within the
<code>SPoRC</code> framework. First, let us extract the data,
parameters, and mapping lists constructed from the functions defined
above.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">input_list</span><span class="op">$</span><span class="va">map</span></span></code></pre></div>
<div class="section level3">
<h3 id="fit-model-without-francis">Fit model (Without Francis)<a class="anchor" aria-label="anchor" href="#fit-model-without-francis"></a>
</h3>
<p>To fit the model without Francis reweighting, users can call the
<code>fit_model</code> helper function and pass the data, parameters,
and mapping list. No random effects are specified for this model, and a
total of 3 newton loops are specified to ensure that the model
approaches a minimum. Following the optimization of the model, we can
extract the standard error report from the model (i.e., standard errors
derived from inverting the Hessian matrix).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit model</span></span>
<span><span class="va">nofrancis_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>                             <span class="va">parameters</span>,</span>
<span>                             <span class="va">mapping</span>,</span>
<span>                             random <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                             newton_loops <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                             silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nofrancis_model</span><span class="op">$</span><span class="va">sdrep</span> <span class="op">&lt;-</span> <span class="fu">RTMB</span><span class="fu">::</span><span class="fu">sdreport</span><span class="op">(</span><span class="va">nofrancis_model</span><span class="op">)</span> <span class="co"># get standard error report</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-model-with-francis">Fit model (With Francis)<a class="anchor" aria-label="anchor" href="#fit-model-with-francis"></a>
</h3>
<p>Conducting Francis re-weighting on composition data requires an
iterative procedure to adjust the effective weights of age and length
compositions based on model fit. First, a separate copy of the data list
(<code>francis_data</code>) is created, which will be updated with
revised weights during the iterations. The number of Francis iterations
is specified (<code>n_francis_iter = 10</code>), which indicates the
number of times the model is refit, where the composition weights are
updated after each model iteration. The <code>run_francis</code>
function then conducts the reweighting procedure and the weights are
saved inside the data list object
(<code>francis_runs$obj$data</code>)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">francis_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="co"># redefine data list for francis (replacing data weights)</span></span>
<span></span>
<span><span class="co"># run francis reweighting</span></span>
<span><span class="va">francis_runs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_francis.html">run_francis</a></span><span class="op">(</span><span class="va">francis_data</span>,</span>
<span>                             <span class="va">parameters</span>,</span>
<span>                             <span class="va">mapping</span>,</span>
<span>                             n_francis_iter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                             newton_loops <span class="op">=</span>  <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get obj</span></span>
<span><span class="va">francis_model</span> <span class="op">&lt;-</span> <span class="va">francis_runs</span><span class="op">$</span><span class="va">obj</span></span>
<span><span class="va">francis_data</span> <span class="op">&lt;-</span> <span class="va">francis_runs</span><span class="op">$</span><span class="va">obj</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">francis_model</span><span class="op">$</span><span class="va">sdrep</span> <span class="op">&lt;-</span> <span class="fu">RTMB</span><span class="fu">::</span><span class="fu">sdreport</span><span class="op">(</span><span class="va">francis_model</span><span class="op">)</span> <span class="co"># get standard error report</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="check-model-results">Check Model Results<a class="anchor" aria-label="anchor" href="#check-model-results"></a>
</h2>
<div class="section level3">
<h3 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h3>
<p>Following model optimization, helper functions can be utilized to
perform post-optimization sanity checks to ensure that the estimates are
reliable. The function <code>post_optim_sanity_checks</code> evaluates
the fit by examining the standard errors, gradients, and correlations of
the parameter estimates. In this example, the function is applied to
both the model without Francis re-weighting
(<code>nofrancis_model</code>) and the model with Francis re-weighting
(<code>francis_model</code>). The checks required users to specify
tolerances for gradients, standard errors, and correlations among
parameters. The following models all appear to pass these sanity
checks.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># check no francis model</span></span>
<span><span class="fu"><a href="../reference/post_optim_sanity_checks.html">post_optim_sanity_checks</a></span><span class="op">(</span><span class="va">nofrancis_model</span><span class="op">$</span><span class="va">sdrep</span>,</span>
<span>                         <span class="va">nofrancis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                         gradient_tol <span class="op">=</span> <span class="fl">1e-5</span>,</span>
<span>                         se_tol <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                         corr_tol <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check francis model</span></span>
<span><span class="fu"><a href="../reference/post_optim_sanity_checks.html">post_optim_sanity_checks</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">sdrep</span>,</span>
<span>                         <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                         gradient_tol <span class="op">=</span> <span class="fl">1e-5</span>,</span>
<span>                         se_tol <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                         corr_tol <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="time-series-results">Time Series Results<a class="anchor" aria-label="anchor" href="#time-series-results"></a>
</h3>
<p>Next, we can compare time series results from the two models using
helper functions in <code>SPoRC.</code> The function
<code>get_ts_plot</code> is used to generate comparative plots of the
Francis re-weighted model and the model without Francis re-weighting.
The resulting list of plots (<code>ts_plot</code>) provides a visual
comparison of key metrics, including spawning biomass, recruitment,
total biomass, and fishing mortality. Accessing
<code>ts_plot[[1]]</code> displays the first plot in the list, which
presents combined time series across all metrics. The function can also
be used for a single model.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ts_plot.html">get_ts_plot</a></span><span class="op">(</span>rep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>, <span class="va">nofrancis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">)</span>,</span>
<span>                       sd_rep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">sdrep</span>, <span class="va">nofrancis_model</span><span class="op">$</span><span class="va">sdrep</span><span class="op">)</span>,</span>
<span>                       model_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"With Francis"</span>, <span class="st">"No Francis"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ts_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="figures/o_ts_comb.png"></p>
</div>
<div class="section level3">
<h3 id="catch-and-index-fits">Catch and Index Fits<a class="anchor" aria-label="anchor" href="#catch-and-index-fits"></a>
</h3>
<p>We can also compare fits to the catch data and index data. This can
be achieved by using the <code>get_catch_fits_plot</code> and
<code>get_idx_fits_plot</code> functions. For fits to the catch data,
this is given by the following code chunk.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_catch_fits_plot.html">get_catch_fits_plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">francis_data</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nofrancis_model</span><span class="op">$</span><span class="va">rep</span>, <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No Francis"</span>, <span class="st">"With Francis"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_catch_fits.png"></p>
<p>Fits to the index data can be illustrated in a similar manner and is
given by the following code chunk.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_idx_fits_plot.html">get_idx_fits_plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">francis_data</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nofrancis_model</span><span class="op">$</span><span class="va">rep</span>, <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No Francis"</span>, <span class="st">"With Francis"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_idx_fits.png"></p>
</div>
<div class="section level3">
<h3 id="composition-fits">Composition Fits<a class="anchor" aria-label="anchor" href="#composition-fits"></a>
</h3>
<p>The GOA Dusky Rockfish model fits to a total of 3 composition
datasets, which include fishery ages and lengths, as well as survey
ages. To inspect these model fits, users can extract the observed and
expected composition proportions using the <code>get_comp_prop</code>
function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract observed and expected compositions</span></span>
<span><span class="va">comp_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_comp_prop.html">get_comp_prop</a></span><span class="op">(</span><span class="va">francis_data</span>,</span>
<span>                           <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                           age_labels <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">30</span>,</span>
<span>                           len_labels <span class="op">=</span> <span class="fl">21</span><span class="op">:</span><span class="fl">52</span>,</span>
<span>                           year_labels <span class="op">=</span> <span class="fl">1977</span><span class="op">:</span><span class="fl">2024</span><span class="op">)</span></span></code></pre></div>
<p>Next, we can then obtain one-step-ahead (OSA) residuals, which uses
the <code>afscOSA</code> package, as well as plot the aggregated fits.
The following code chunk computes OSA residuals for composition data to
assess model fit. The <code>get_osa</code> function computes these
residuals by comparing observed (<code>Obs_FishAge_mat</code>) and
predicted (<code>Pred_FishAge_mat</code>) age compositions, while
accounting for effective sample sizes that combine the input sample size
with Francis re-weighting factors, across the years and age bins of
interest for fleet 1. We can then visualize these residuals with
<code><a href="../reference/plot_resids.html">SPoRC::plot_resids</a></code>, which generates diagnostic plots such
as bubble plots and QQ plots. We can also additionally plot the
aggregated fits to the composition data as a further diagnostic
tool.</p>
<div class="section level4">
<h4 id="fishery-ages">Fishery Ages<a class="anchor" aria-label="anchor" href="#fishery-ages"></a>
</h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get one step ahead fishery ages</span></span>
<span><span class="va">fishages</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_osa.html">get_osa</a></span><span class="op">(</span>obs_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Obs_FishAge_mat</span>, <span class="co"># observed fishery age compositions</span></span>
<span>                    exp_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Pred_FishAge_mat</span>, <span class="co"># predicted fishery age compositions</span></span>
<span>                    N <span class="op">=</span> <span class="va">francis_data</span><span class="op">$</span><span class="va">ISS_FishAgeComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="co"># input sample size</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">Wt_FishAgeComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># francis weight</span></span>
<span>                    years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># years with fishery ages</span></span>
<span>                    fleet <span class="op">=</span> <span class="fl">1</span>, <span class="co"># fleet</span></span>
<span>                    bins <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">30</span>, <span class="co"># age bins</span></span>
<span>                    comp_type <span class="op">=</span> <span class="fl">0</span>, <span class="co"># composition type (age-specific)</span></span>
<span>                    bin_label <span class="op">=</span> <span class="st">"Ages"</span> <span class="co"># bin labels</span></span>
<span>                    <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot OSA residuals</span></span>
<span><span class="va">resid_plot</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_resids.html">plot_resids</a></span><span class="op">(</span>osa_results <span class="op">=</span> <span class="va">fishages</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Aggregated Plot</span></span>
<span><span class="va">fishage_agg</span> <span class="op">&lt;-</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Fishery_Ages</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Age</span>, <span class="va">Fleet</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Fleet</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'darkgreen'</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Age'</span>, y <span class="op">=</span> <span class="st">'Proportions'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="co"># Bubble</span></span>
<span>                   <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">fishage_agg</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># QQ and Aggregated</span></span>
<span>                   ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_fishage_fits.png"></p>
</div>
<div class="section level4">
<h4 id="fishery-lengths">Fishery Lengths<a class="anchor" aria-label="anchor" href="#fishery-lengths"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get one step ahead fishery lengths</span></span>
<span><span class="va">fishlens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_osa.html">get_osa</a></span><span class="op">(</span>obs_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Obs_FishLen_mat</span>, <span class="co"># observed fishery length compositions</span></span>
<span>                    exp_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Pred_FishLen_mat</span>, <span class="co"># predicted fishery length compositions</span></span>
<span>                    N <span class="op">=</span> <span class="va">francis_data</span><span class="op">$</span><span class="va">ISS_FishLenComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishLenComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="co"># input sample size</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">Wt_FishLenComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishLenComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># francis weight</span></span>
<span>                    years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseFishLenComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># years with fishery ages</span></span>
<span>                    fleet <span class="op">=</span> <span class="fl">1</span>, <span class="co"># fleet</span></span>
<span>                    bins <span class="op">=</span> <span class="fl">21</span><span class="op">:</span><span class="fl">52</span>, <span class="co"># age bins</span></span>
<span>                    comp_type <span class="op">=</span> <span class="fl">0</span>, <span class="co"># composition type (age-specific)</span></span>
<span>                    bin_label <span class="op">=</span> <span class="st">"Lengths"</span> <span class="co"># bin labels</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot OSA residuals</span></span>
<span><span class="va">resid_plot</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_resids.html">plot_resids</a></span><span class="op">(</span>osa_results <span class="op">=</span> <span class="va">fishlens</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Aggregated Plot</span></span>
<span><span class="va">fishlen_agg</span> <span class="op">&lt;-</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Fishery_Lens</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Len</span>, <span class="va">Fleet</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Fleet</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Len</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'darkgreen'</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Len</span>, y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Lengths'</span>, y <span class="op">=</span> <span class="st">'Proportions'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="co"># Bubble</span></span>
<span>                   <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">fishlen_agg</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># QQ and Aggregated</span></span>
<span>                   ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_fishlen_fits.png"></p>
</div>
<div class="section level4">
<h4 id="survey-ages">Survey Ages<a class="anchor" aria-label="anchor" href="#survey-ages"></a>
</h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get one step ahead survey ages</span></span>
<span><span class="va">srvages</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_osa.html">get_osa</a></span><span class="op">(</span>obs_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Obs_SrvAge_mat</span>, <span class="co"># observed survey age compositions</span></span>
<span>                   exp_mat <span class="op">=</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Pred_SrvAge_mat</span>, <span class="co"># predicted survey age compositions</span></span>
<span>                   N <span class="op">=</span> <span class="va">francis_data</span><span class="op">$</span><span class="va">ISS_SrvAgeComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="co"># input sample size</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">Wt_SrvAgeComps</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># francis weight</span></span>
<span>                   years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">UseSrvAgeComps</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># years with survey ages</span></span>
<span>                   fleet <span class="op">=</span> <span class="fl">1</span>, <span class="co"># fleet</span></span>
<span>                   bins <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">30</span>, <span class="co"># age bins</span></span>
<span>                   comp_type <span class="op">=</span> <span class="fl">0</span>, <span class="co"># composition type (age-specific)</span></span>
<span>                   bin_label <span class="op">=</span> <span class="st">"Ages"</span> <span class="co"># bin labels</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot OSA residuals</span></span>
<span><span class="va">resid_plot</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_resids.html">plot_resids</a></span><span class="op">(</span>osa_results <span class="op">=</span> <span class="va">srvages</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Aggregated Plot</span></span>
<span><span class="va">srvage_agg</span> <span class="op">&lt;-</span> <span class="va">comp_prop</span><span class="op">$</span><span class="va">Survey_Ages</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Age</span>, <span class="va">Fleet</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Fleet</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'darkgreen'</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Age</span>, y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Age'</span>, y <span class="op">=</span> <span class="st">'Proportions'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="co"># Bubble</span></span>
<span>                   <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">resid_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">srvage_agg</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># QQ and Aggregated</span></span>
<span>                   ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_srvage_fits.png"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="retrospectives">Retrospectives<a class="anchor" aria-label="anchor" href="#retrospectives"></a>
</h2>
<p>In addition to evaluating model fits, it is useful to examine the
retrospective behavior of the model to identify potential
misspecifications and assess the consistency of management advice over
time. This can be done using the <code>do_retrospective</code> function,
which performs a retrospective analysis by sequentially removing data
from years prior to the terminal year. For models with Francis
re-weighting, each retrospective peel also updates the composition
weights, whereas models without re-weighting do not. The
<code>get_retrospective_plot</code> function then generates
visualizations of the retrospective results, including plots of relative
differences, absolute scale differences, and a squid plot of
recruitment.</p>
<div class="section level3">
<h3 id="retrospectives-without-francis">Retrospectives (Without Francis)<a class="anchor" aria-label="anchor" href="#retrospectives-without-francis"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofrancis_retro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/do_retrospective.html">do_retrospective</a></span><span class="op">(</span></span>
<span>  n_retro <span class="op">=</span> <span class="fl">10</span>, <span class="co"># number of peels</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>, <span class="co"># data list (not francis data)</span></span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>, <span class="co"># parameters list</span></span>
<span>  mapping <span class="op">=</span> <span class="va">mapping</span>, <span class="co"># mapping list</span></span>
<span>  random <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># random effects</span></span>
<span>  do_par <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># whether to parallellize</span></span>
<span>  n_cores <span class="op">=</span> <span class="fl">8</span>,  <span class="co"># number of cores to use</span></span>
<span>  do_francis <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co"># whether to do francis within a given retrospective peel</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get retrospective plots</span></span>
<span><span class="va">nofrancis_retro_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_retrospective_plot.html">get_retrospective_plot</a></span><span class="op">(</span><span class="va">nofrancis_retro</span>, Rec_Age <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">nofrancis_retro_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">nofrancis_retro_plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">nofrancis_retro_plot</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="figures/o_nofrancis_rel_retro.png"><img src="figures/o_nofrancis_abs_retro.png"><img src="figures/o_nofrancis_squid_retro.png"></p>
</div>
<div class="section level3">
<h3 id="retrospectives-with-francis">Retrospectives (With Francis)<a class="anchor" aria-label="anchor" href="#retrospectives-with-francis"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># do retrospective w/ francis</span></span>
<span><span class="va">francis_retro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/do_retrospective.html">do_retrospective</a></span><span class="op">(</span></span>
<span>  n_retro <span class="op">=</span> <span class="fl">10</span>, <span class="co"># number of peels</span></span>
<span>  data <span class="op">=</span> <span class="va">francis_data</span>, <span class="co"># data list (francis data)</span></span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>, <span class="co"># parameters list</span></span>
<span>  mapping <span class="op">=</span> <span class="va">mapping</span>, <span class="co"># mapping list</span></span>
<span>  random <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># random effects</span></span>
<span>  do_par <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># whether to parallellize</span></span>
<span>  n_cores <span class="op">=</span> <span class="fl">8</span>,  <span class="co"># number of cores to use</span></span>
<span>  do_francis <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># whether to do francis within a given retrospective peel</span></span>
<span>  n_francis_iter <span class="op">=</span> <span class="fl">10</span> <span class="co"># number of francis iterations to run within a given retrospective peel</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get retrospective plot</span></span>
<span><span class="va">francis_retro_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_retrospective_plot.html">get_retrospective_plot</a></span><span class="op">(</span><span class="va">francis_retro</span>, Rec_Age <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">francis_retro_plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">francis_retro_plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">francis_retro_plot</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="figures/o_francis_rel_retro.png"><img src="figures/o_francis_abs_retro.png"><img src="figures/o_francis_squid_retro.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="likelihood-profiles">Likelihood Profiles<a class="anchor" aria-label="anchor" href="#likelihood-profiles"></a>
</h2>
<p>Another useful diagnostic tool that can help identify data conflits
and the potential need to re-parameterize the model are likelihood
profiles. Here, the <code>do_likelihood_profile</code> function is used
to profile the parameter <code>ln_global_R0</code> in the Francis
re-weighted model. The function takes the data list, parameter list, and
mapping list, and iteratively evaluates the likelihood across a
specified range of values. The <code>do_likelihood_profile</code> then
outputs a list of profiled values for each data component with their
respective dimensions (e.g., likelihood profiles by fleet, region, year,
etc.) as well likelihood profiles for each data component, aggregated
across all their respective dimensions.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># do likelihood profile with francis weights</span></span>
<span><span class="va">francis_meanrec_prof</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/do_likelihood_profile.html">do_likelihood_profile</a></span><span class="op">(</span></span>
<span>  <span class="va">francis_data</span>, <span class="co"># francis data list</span></span>
<span>  <span class="va">parameters</span>, <span class="co"># parameter list</span></span>
<span>  <span class="va">mapping</span>, <span class="co"># mapping list</span></span>
<span>  random <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># random effects</span></span>
<span>  what <span class="op">=</span> <span class="st">'ln_global_R0'</span>, <span class="co"># parameter to profile</span></span>
<span>  min_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">R0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span>,  <span class="co"># min values to profile across</span></span>
<span>  max_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">R0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span>,  <span class="co"># max values to profile across</span></span>
<span>  inc <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># increment for min and max values to profile across</span></span>
<span>  do_par <span class="op">=</span>  <span class="cn">TRUE</span>, <span class="co"># whether to parrallelize</span></span>
<span>  n_cores <span class="op">=</span> <span class="fl">8</span> <span class="co"># number of cores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize profile</span></span>
<span><span class="va">francis_mean_rec_profile</span> <span class="op">&lt;-</span> <span class="va">francis_meanrec_prof</span><span class="op">$</span><span class="va">agg_nLL</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Summarized_Type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"Pen|Prior"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"Len"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Length Comps"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"Age"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Age Comps"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"Idx"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Indices"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"Catch"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Catch"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"jnLL"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"jnLL"</span>,</span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Summarized_Type</span>, <span class="va">prof_val</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Summarized_Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">value</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">francis_mean_rec_profile</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">prof_val</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">Summarized_Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">R0</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Log Mean Recruitment'</span>, y <span class="op">=</span> <span class="st">"Scaled nLL"</span>, color <span class="op">=</span> <span class="st">"Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_meanrec_profile.png"></p>
</div>
<div class="section level2">
<h2 id="jitter-analysis">Jitter Analysis<a class="anchor" aria-label="anchor" href="#jitter-analysis"></a>
</h2>
<p>Jitter analysis is a useful diagnostic for assessing whether a model
has truly converged, if it may be stuck in a local minimum, and to
understand model stability. The <code>do_jitter</code> function perturbs
the initial parameter values by adding random noise and refits the model
multiple times. In this example, 50 jittered starts are generated for
the Francis re-weighted model, with a standard deviation of 0.5
(additive normal) applied to the initial parameter values. Each jittered
model is optimized using three Newton loops, and parallel processing
with 8 cores is used to enhance computational speed. We can then plot
the jitter results to understand the number of times the model has
converged, whether a better solution was achieved, and trajectories of
spawning biomass and recruitment from these jitter results.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get jitter results</span></span>
<span><span class="va">jitter_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/do_jitter.html">do_jitter</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">francis_data</span>, <span class="co"># francis data list</span></span>
<span>                               parameters <span class="op">=</span> <span class="va">parameters</span>, <span class="co"># parameter list</span></span>
<span>                               mapping <span class="op">=</span> <span class="va">mapping</span>, <span class="co"># mapping list</span></span>
<span>                               random <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># random effects</span></span>
<span>                               sd <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># standard deviation for jitter</span></span>
<span>                               n_jitter <span class="op">=</span> <span class="fl">50</span>, <span class="co"># number of jitters</span></span>
<span>                               n_newton_loops <span class="op">=</span> <span class="fl">3</span>, <span class="co"># newton loops to od</span></span>
<span>                               do_par <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># whether to parrallelize</span></span>
<span>                               n_cores <span class="op">=</span> <span class="fl">8</span> <span class="co"># number of cores to use</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get proportion converged</span></span>
<span><span class="va">prop_converged</span> <span class="op">&lt;-</span> <span class="va">jitter_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">Type</span> <span class="op">==</span> <span class="st">'Recruitment'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>prop_conv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Hessian</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Hessian</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get jitter results</span></span>
<span><span class="va">final_mod</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'SSB'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Year <span class="op">=</span> <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">'Recruitment'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">jitter_res</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span> <span class="op">+</span> <span class="fl">1976</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">jitter</span>, color <span class="op">=</span> <span class="va">Hessian</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">final_mod</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span> <span class="op">+</span> <span class="fl">1976</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">1.3</span> , lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">Type</span><span class="op">~</span><span class="va">Region</span>, scales <span class="op">=</span> <span class="st">'free'</span>,</span>
<span>             labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Region "</span>, <span class="va">x</span><span class="op">)</span>,</span>
<span>                                 Type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Recruitment"</span> <span class="op">=</span> <span class="st">"Age 2 Recruitment (millions)"</span>, <span class="st">"SSB"</span> <span class="op">=</span> <span class="st">'SSB (kt)'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year"</span>, y <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">'grey'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">jitter_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Type</span> <span class="op">==</span> <span class="st">'SSB'</span>, <span class="va">Year</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">jitter</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">Inf</span>, y <span class="op">=</span> <span class="cn">Inf</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Proportion Converged: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">prop_converged</span><span class="op">$</span><span class="va">prop_conv</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            hjust <span class="op">=</span> <span class="fl">1.1</span>, vjust <span class="op">=</span> <span class="fl">1.9</span>, size <span class="op">=</span> <span class="fl">6</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_jiter_ts.png"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">jitter_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">jitter</span>, y <span class="op">=</span> <span class="va">jnLL</span>, color <span class="op">=</span> <span class="va">Max_Gradient</span>, shape <span class="op">=</span> <span class="va">Hessian</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">jnLL</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Hessian</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span></span>
<span>    Hessian <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"non-PD Hessian"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">'PD Hessian'</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barwidth <span class="op">=</span> <span class="fl">15</span>, barheight <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Jitter'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">jitter_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Hessian</span> <span class="op">==</span> <span class="cn">TRUE</span>, <span class="va">Year</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">jitter</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">Inf</span>, y <span class="op">=</span> <span class="cn">Inf</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Proportion Converged: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">prop_converged</span><span class="op">$</span><span class="va">prop_conv</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            hjust <span class="op">=</span> <span class="fl">1.1</span>, vjust <span class="op">=</span> <span class="fl">1.9</span>, size <span class="op">=</span> <span class="fl">6</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_jitter_res.png"></p>
</div>
<div class="section level2">
<h2 id="mcmc">MCMC<a class="anchor" aria-label="anchor" href="#mcmc"></a>
</h2>
<p>Lastly, SPoRC can also interact with other Bayesian software (i.e,
<code>adnuts</code>) to conduct MCMC analysis, which not only estimates
parameter uncertainty but also samples the full joint posterior,
revealing parameter correlations, skewed distributions, or potential
multimodality that MLE may miss. Comparing MCMC results with maximum
likelihood estimates further helps assess consistency in point estimates
and standard errors. In particular, we can utilize the native
functionality built into <code>adnuts</code>, which seamlessly
integrates with TMB and RTMB models, which will be demonstrated in the
following sections. First, let us install and load in the relevant
packages.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load in adnuts ans associated packages for MCMC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'StanEstimators'</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'&lt;https://andrjohns.r-universe.dev&gt;'</span>, <span class="st">'&lt;https://cloud.r-project.org&gt;'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">'Cole-Monnahan-NOAA/adnuts'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Cole-Monnahan-NOAA.github.io/adnuts" class="external-link">adnuts</a></span><span class="op">)</span></span></code></pre></div>
<p>The <code>sample_snuts</code> function in <code>adnuts</code> runs a
Bayesian MCMC analysis using the RTMB model. In this example, four
chains are run for 10,000 iterations each, along with 4 Markov chains.
Additionally, the <code>adapt_delta</code> is set a 0.99 to ensure that
the model takes smaller steps, which helps improve MCMC model
convergence. Default settings are used throughout this example
<code>sample_snuts</code> and users can refer to <a href="https://cole-monnahan-noaa.github.io/adnuts/" class="external-link uri">https://cole-monnahan-noaa.github.io/adnuts/</a> for further
details. After running MCMC diagnostics, users can then inspect summary
statistics from the model object, which includes posterior means,
standard deviations, effective sample sizes (<code>n_eff</code>), and
convergence diagnostics (<code>R_hat</code>).</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run MCMC</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Cole-Monnahan-NOAA.github.io/adnuts/reference/sample_snuts.html" class="external-link">sample_snuts</a></span><span class="op">(</span><span class="va">francis_model</span>, num_samples <span class="op">=</span> <span class="fl">1e4</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check MCMC summary</span></span>
<span><span class="va">diag_df</span> <span class="op">&lt;-</span> <span class="va">mcmc</span><span class="op">$</span><span class="va">monitor</span></span></code></pre></div>
<p>We can then inspect various model diagnostics, ranging from pairs
plots, comparisons of the marginal distributions between MLE and MCMC,
trace plots, and comparisons of uncertainty between MCMC and MLE.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Cole-Monnahan-NOAA.github.io/adnuts/reference/plot_marginals.html" class="external-link">plot_marginals</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Cole-Monnahan-NOAA.github.io/adnuts/reference/plot_uncertainties.html" class="external-link">plot_uncertainties</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_mcmc_pairs_trace.png"><img src="figures/o_mcmc_dens.png"><img src="figures/o_mcmc_mle_comp.png"></p>
<p>Time series of recruitment and spawning stock biomass derived from
posterior samples can also readily be plotted.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get mcmc time series plots</span></span>
<span><span class="va">mcmc_ts_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_model_rep_from_mcmc.html">get_model_rep_from_mcmc</a></span><span class="op">(</span>rmtb_obj <span class="op">=</span> <span class="va">francis_model</span>, adnuts_obj <span class="op">=</span> <span class="va">mcmc_short</span>, what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SSB"</span>, <span class="st">"Rec"</span><span class="op">)</span>, n_cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssb plot</span></span>
<span><span class="co"># summarize results</span></span>
<span><span class="va">ssb_summry</span> <span class="op">&lt;-</span> <span class="va">mcmc_ts_plot</span><span class="op">$</span><span class="va">SSB</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var1</span>, <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">ssb_summry</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="va">ssb_summry</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span>, lwd <span class="op">=</span> <span class="fl">1.3</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Year'</span>, y <span class="op">=</span> <span class="st">'Spawning Stock Biomass'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rec plot</span></span>
<span><span class="co"># summarize results</span></span>
<span><span class="va">rec_summry</span> <span class="op">&lt;-</span> <span class="va">mcmc_ts_plot</span><span class="op">$</span><span class="va">Rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Var1</span>, <span class="va">Var2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>            lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="va">rec_summry</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="va">rec_summry</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">median</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">)</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span>, lwd <span class="op">=</span> <span class="fl">1.3</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Year'</span>, y <span class="op">=</span> <span class="st">'Recruitment'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_mcmc_ssb_plot.png"><img src="figures/o_mcmc_rec_plot.png"></p>
</div>
<div class="section level2">
<h2 id="reference-points-and-projections">Reference Points and Projections<a class="anchor" aria-label="anchor" href="#reference-points-and-projections"></a>
</h2>
<p>The final step in the assessment workflow is to provide management
advice based on reference points derived from model estimates. For the
GOA Dusky Rockfish model, reference points are based on spawning
potential ratios, aiming to maintain the population at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{40\%}</annotation></semantics></math>
by fishing at or below
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>.
These reference points are then projected forward to generate catch
advice for future years. Additionally, in compliance with the
Magnuson-Stevens Reauthorization Act, a range of projection scenarios
need to be conducted to evaluate whether the population is within
sustainable limits.</p>
<div class="section level3">
<h3 id="reference-points">Reference Points<a class="anchor" aria-label="anchor" href="#reference-points"></a>
</h3>
<p>To derive reference points for catch advice and population
projections, the <code>Get_Reference_Points</code> function is used.
Reference points corresponding to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>P</mi><msub><mi>R</mi><mrow><mn>35</mn><mi>%</mi></mrow></msub></mrow><annotation encoding="application/x-tex">SPR_{35\%}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>P</mi><msub><mi>R</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub></mrow><annotation encoding="application/x-tex">SPR_{40\%}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>P</mi><msub><mi>R</mi><mrow><mn>60</mn><mi>%</mi></mrow></msub></mrow><annotation encoding="application/x-tex">SPR_{60\%}</annotation></semantics></math>
are calculated. The <code>calc_rec_st_yr</code> argument specifies the
vector of estimated recruitment starting from year 3 (which corresponds
to 1979), and subtracts the terminal year by <code>rec_age = 4</code> to
compute the mean recruitment used in calculating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mi>x</mi><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{x\%}</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get reference points</span></span>
<span><span class="va">spr_35</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Get_Reference_Points.html">Get_Reference_Points</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">francis_data</span>,</span>
<span>                               rep <span class="op">=</span> <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                               SPR_x <span class="op">=</span> <span class="fl">0.35</span>, t_spwn <span class="op">=</span> <span class="fl">0</span>, sex_ratio_f <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                               type <span class="op">=</span> <span class="st">"single_region"</span>,</span>
<span>                               what <span class="op">=</span> <span class="st">'SPR'</span>,</span>
<span>                               calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>, rec_age <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spr_40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Get_Reference_Points.html">Get_Reference_Points</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">francis_data</span>,</span>
<span>                               rep <span class="op">=</span> <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                               type <span class="op">=</span> <span class="st">"single_region"</span>,</span>
<span>                               what <span class="op">=</span> <span class="st">'SPR'</span>,</span>
<span>                               SPR_x <span class="op">=</span> <span class="fl">0.4</span>, t_spwn <span class="op">=</span> <span class="fl">0</span>, sex_ratio_f <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                               calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>, rec_age <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spr_60</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Get_Reference_Points.html">Get_Reference_Points</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">francis_data</span>,</span>
<span>                               rep <span class="op">=</span> <span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span>,</span>
<span>                               type <span class="op">=</span> <span class="st">"single_region"</span>,</span>
<span>                               what <span class="op">=</span> <span class="st">'SPR'</span>,</span>
<span>                               SPR_x <span class="op">=</span> <span class="fl">0.6</span>, t_spwn <span class="op">=</span> <span class="fl">0</span>, sex_ratio_f <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                               calc_rec_st_yr <span class="op">=</span> <span class="fl">3</span>, rec_age <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract reference points</span></span>
<span><span class="va">b40</span> <span class="op">&lt;-</span> <span class="va">spr_40</span><span class="op">$</span><span class="va">b_ref_pt</span></span>
<span><span class="va">b60</span> <span class="op">&lt;-</span> <span class="va">spr_60</span><span class="op">$</span><span class="va">b_ref_pt</span></span>
<span><span class="va">b35</span> <span class="op">&lt;-</span> <span class="va">spr_35</span><span class="op">$</span><span class="va">b_ref_pt</span></span>
<span><span class="va">f40</span> <span class="op">&lt;-</span> <span class="va">spr_40</span><span class="op">$</span><span class="va">f_ref_pt</span></span>
<span><span class="va">f35</span> <span class="op">&lt;-</span> <span class="va">spr_35</span><span class="op">$</span><span class="va">f_ref_pt</span></span>
<span><span class="va">f60</span> <span class="op">&lt;-</span> <span class="va">spr_60</span><span class="op">$</span><span class="va">f_ref_pt</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="projections">Projections<a class="anchor" aria-label="anchor" href="#projections"></a>
</h3>
<p>The reference points derived above can be used to provide catch
advice through population projections. First, a harvest control rule
(HCR) is defined with the <code>HCR_function</code>, which determines
fishing mortality based on stock status relative to a reference biomass
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mrow><mi>x</mi><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">B_{x\%}</annotation></semantics></math>.
If stock status is at or above the reference point, fishing occurs at
the target
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mi>x</mi><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{x\%}</annotation></semantics></math>;
if stock status falls between a lower threshold (<code>alpha</code>) and
the reference point, fishing mortality is scaled linearly; and if stock
status is below the threshold, fishing is set to zero. Projection
parameters are then specified, including the number of simulations
(<code>n_sims</code>), projection years (<code>n_proj_yrs</code>), sex
ratio, number of regions, ages, and fleets. Arrays are initialized for
terminal numbers-at-age (<code>terminal_NAA</code>), weight-at-age
(<code>WAA</code> and <code>WAA_fish</code>), maturity-at-age
(<code>MatAA</code>), selectivity (<code>fish_sel</code>), movement (not
used in this single-region model), terminal fishing mortality
(<code>terminal_F</code>), natural mortality (<code>natmort</code>), and
recruitment, using the terminal values and historical recruitment from
the fitted Francis re-weighted model. These inputs then form the basis
for projecting future population dynamics and deriving catch advice
under the specified HCR.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define HCR to use for projections</span></span>
<span><span class="va">HCR_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">frp</span>, <span class="va">brp</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stock_status</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="va">brp</span> <span class="co"># define stock status</span></span>
<span>  <span class="co"># If stock status is &gt; 1</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span></span>
<span>  <span class="co"># If stock status is between brp and alpha</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&gt;</span> <span class="va">alpha</span> <span class="op">&amp;&amp;</span> <span class="va">stock_status</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">frp</span> <span class="op">*</span> <span class="op">(</span><span class="va">stock_status</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="co"># If stock status is less than alpha</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">stock_status</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define projection parameters</span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">1e3</span></span>
<span><span class="va">t_spawn</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">n_proj_yrs</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="va">n_regions</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">n_ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span></span>
<span><span class="va">n_sexes</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">n_fish_fleets</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">n_sexes</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">do_recruits_move</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">terminal_NAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">terminal_NAA0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">NAA0</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">WAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age</span></span>
<span><span class="va">WAA_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">WAA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span>, <span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># weight at age for fishery</span></span>
<span><span class="va">MatAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">MatAA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># maturity at age</span></span>
<span><span class="va">fish_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">fish_sel</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span>, <span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># selectivity</span></span>
<span><span class="va">Movement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Movement</span><span class="op">[</span>,,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># movement - not used</span></span>
<span><span class="va">terminal_F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,<span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_fish_fleets</span><span class="op">)</span><span class="op">)</span> <span class="co"># terminal F</span></span>
<span><span class="va">natmort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">natmort</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,,<span class="op">]</span>, each <span class="op">=</span> <span class="va">n_proj_yrs</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_ages</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># natural mortaility</span></span>
<span><span class="va">recruitment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Rec</span><span class="op">[</span>,<span class="fl">3</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span> <span class="op">-</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span> <span class="op">-</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># recruitment from years 3 - terminal (corresponds to 1979)</span></span>
<span><span class="va">sexratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_sexes</span><span class="op">)</span><span class="op">)</span> <span class="co"># recruitment sex ratio </span></span></code></pre></div>
<p>Next, we can define the Alaska projection scenarios to understand if
the stock is within sustainable limits. These scenarios vary in how
fishing mortality is applied relative to biological reference points.
Scenario 1 applies the harvest control rule (HCR) using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
as the maximum allowable fishing mortality, with the annual mean of
catch across simulations providing the annual catch advice. Scenario 2
also uses the HCR but scales
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
based on the previous year’s fishing mortality. Scenario 3 applies a
constant fishing mortality equal to the average of the last five years.
Scenario 4 applies fishing mortality using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>60</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{60\%}</annotation></semantics></math>,
while Scenario 5 assumes no fishing. Scenario 6 applies the HCR with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>35</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{35\%}</annotation></semantics></math>,
representing the overfishing limit (<code>FOFL</code>). Finally,
Scenario 7 applies the HCR with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
in the first two projection years and then transitions to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>35</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{35\%}</annotation></semantics></math>
in later years.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the F used for each scenario (Based on BSAI Intro Report - Alaska Scenarios)</span></span>
<span><span class="va">proj_inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Scenario 1 - Using HCR to adjust maxFABC</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">f40</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">b40</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'HCR'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 2 - Using HCR to adjust maxFABC based on last year's value (constant fraction - author specified F)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">f40</span> <span class="op">*</span> <span class="op">(</span><span class="va">f40</span> <span class="op">/</span> <span class="fl">0.091</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">b40</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'HCR'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 3 - Using an F input of last 5 years average F, and</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">43</span><span class="op">:</span><span class="fl">47</span>,<span class="op">]</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'Input'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 4 - Using F60</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">f60</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'Input'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 5 - F is set at 0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'Input'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 6 - Using HCR to adjust FOFL</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">f35</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">b35</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'HCR'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Scenario 7 - Using HCR to adjust FABC in first 2 projection years, and then later years are adjusting FOFL</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">f40</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">f35</span>, <span class="va">n_proj_yrs</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       b_ref_pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">b40</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">b35</span>, <span class="va">n_proj_yrs</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       fmort_opt <span class="op">=</span> <span class="st">'HCR'</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Following the setup of the seven projection scenarios, we can then
simulate the population dynamics forward under each case to evaluate
future spawning biomass, fishing mortality, and catch. The code below
loops over all projection scenarios and simulation replicates, keeping
record of spawning stock biomass, fishing mortality, and catch,</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># store outputs</span></span>
<span><span class="va">all_scenarios_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">proj_inputs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all_scenarios_ssb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">proj_inputs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all_scenarios_catch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="va">n_proj_yrs</span>, <span class="va">n_fish_fleets</span>, <span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">proj_inputs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">proj_inputs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># do population projection</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">SPoRC</span><span class="fu">::</span><span class="fu"><a href="../reference/Do_Population_Projection.html">Do_Population_Projection</a></span><span class="op">(</span>n_proj_yrs <span class="op">=</span> <span class="va">n_proj_yrs</span>,</span>
<span>                                           n_regions <span class="op">=</span> <span class="va">n_regions</span>,</span>
<span>                                           n_ages <span class="op">=</span> <span class="va">n_ages</span>,</span>
<span>                                           n_sexes <span class="op">=</span> <span class="va">n_sexes</span>,</span>
<span>                                           sexratio <span class="op">=</span> <span class="va">sexratio</span>,</span>
<span>                                           n_fish_fleets <span class="op">=</span> <span class="va">n_fish_fleets</span>,</span>
<span>                                           do_recruits_move <span class="op">=</span> <span class="va">do_recruits_move</span>,</span>
<span>                                           recruitment <span class="op">=</span> <span class="va">recruitment</span>,</span>
<span>                                           terminal_NAA <span class="op">=</span> <span class="va">terminal_NAA</span>,</span>
<span>                                           terminal_NAA0 <span class="op">=</span> <span class="va">terminal_NAA0</span>,</span>
<span>                                           terminal_F <span class="op">=</span> <span class="va">terminal_F</span>,</span>
<span>                                           natmort <span class="op">=</span> <span class="va">natmort</span>,</span>
<span>                                           WAA <span class="op">=</span> <span class="va">WAA</span>,</span>
<span>                                           WAA_fish <span class="op">=</span> <span class="va">WAA_fish</span>,</span>
<span>                                           MatAA <span class="op">=</span> <span class="va">MatAA</span>,</span>
<span>                                           fish_sel <span class="op">=</span> <span class="va">fish_sel</span>,</span>
<span>                                           Movement <span class="op">=</span> <span class="va">Movement</span>,</span>
<span>                                           f_ref_pt <span class="op">=</span> <span class="va">proj_inputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">f_ref_pt</span>,</span>
<span>                                           b_ref_pt <span class="op">=</span> <span class="va">proj_inputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">b_ref_pt</span>,</span>
<span>                                           HCR_function <span class="op">=</span> <span class="va">HCR_function</span>,</span>
<span>                                           recruitment_opt <span class="op">=</span> <span class="st">"inv_gauss"</span>,</span>
<span>                                           fmort_opt <span class="op">=</span> <span class="va">proj_inputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fmort_opt</span>,</span>
<span>                                           t_spawn <span class="op">=</span> <span class="va">t_spawn</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">all_scenarios_ssb</span><span class="op">[</span>,,<span class="va">sim</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">proj_SSB</span></span>
<span>    <span class="va">all_scenarios_catch</span><span class="op">[</span>,,,<span class="va">sim</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">proj_Catch</span></span>
<span>    <span class="va">all_scenarios_f</span><span class="op">[</span>,,<span class="va">sim</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">proj_F</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">n_proj_yrs</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="co"># remove last year, since it's not used</span></span>
<span>  <span class="op">}</span> <span class="co"># end sim loop</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="co"># end i loop</span></span></code></pre></div>
<p>Projections of spawning stock biomass, catch advice, and fishing
mortality can then be visualized as follows.</p>
<div class="section level4">
<h4 id="spawning-biomass-projections">Spawning Biomass Projections<a class="anchor" aria-label="anchor" href="#spawning-biomass-projections"></a>
</h4>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get historical SSB</span></span>
<span><span class="va">historical</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>                                   dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">1976</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="st">"FABC (F40)"</span>,  <span class="co"># or change to match the scenarios you're plotting</span></span>
<span>         Type <span class="op">=</span> <span class="st">"Historical"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var3</span>, SSB <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all scenario projections</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">all_scenarios_ssb</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">2023</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"S1: FABC (F40)"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"S2: FABC Ratio"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"S3: F Last 5 Years"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"S4: F60 SPR"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"S5: No Fishing"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"S6: FOFL"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"S7: FABC -&gt; FOFL"</span>,</span>
<span>           <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Scenario"</span>, <span class="va">Var4</span><span class="op">)</span></span>
<span>         <span class="op">)</span>,</span>
<span>         Type <span class="op">=</span> <span class="st">"Projection"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var3</span>, SSB <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># expand historical SSB for plotting</span></span>
<span><span class="va">scenarios_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">$</span><span class="va">Scenario</span><span class="op">)</span></span>
<span><span class="va">historical_expanded</span> <span class="op">&lt;-</span> <span class="va">historical</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scenarios_unique</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">historical_expanded</span><span class="op">$</span><span class="va">Scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">scenarios_unique</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine</span></span>
<span><span class="va">combined_ssb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">historical_expanded</span>, <span class="va">scenarios</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_ssb</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">SSB</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">Scenario</span>, <span class="va">Simulation</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">b40</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Historical"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Projection"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projall_ssb.png"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_ssb</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">SSB</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            SSB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">SSB</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">SSB</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">b40</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projzoom_ssb.png"></p>
</div>
<div class="section level4">
<h4 id="catch-projections">Catch Projections<a class="anchor" aria-label="anchor" href="#catch-projections"></a>
</h4>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get historical catch</span></span>
<span><span class="va">historical</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">ObsCatch</span>, <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>                                   dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">francis_data</span><span class="op">$</span><span class="va">n_fish_fleets</span>, <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">1976</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="st">"FABC (F40)"</span>,  <span class="co"># or change to match the scenarios you're plotting</span></span>
<span>         Type <span class="op">=</span> <span class="st">"Historical"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var4</span>, Fleet <span class="op">=</span> <span class="va">Var3</span>, Catch <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Var2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">historical</span><span class="op">$</span><span class="va">Catch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">historical</span><span class="op">$</span><span class="va">Catch</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Get all scenario projections</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">all_scenarios_catch</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">2023</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"S1: FABC (F40)"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"S2: FABC Ratio"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"S3: F Last 5 Years"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"S4: F60 SPR"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"S5: No Fishing"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"S6: FOFL"</span>,</span>
<span>           <span class="va">Var5</span> <span class="op">==</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"S7: FABC -&gt; FOFL"</span>,</span>
<span>           <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Scenario"</span>, <span class="va">Var5</span><span class="op">)</span></span>
<span>         <span class="op">)</span>,</span>
<span>         Type <span class="op">=</span> <span class="st">"Projection"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var4</span>, Catch <span class="op">=</span> <span class="va">value</span>, Fleet <span class="op">=</span> <span class="va">Var3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Var2</span>, <span class="va">Var5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># expand historical catch for plotting</span></span>
<span><span class="va">scenarios_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">$</span><span class="va">Scenario</span><span class="op">)</span></span>
<span><span class="va">historical_expanded</span> <span class="op">&lt;-</span> <span class="va">historical</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scenarios_unique</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">historical_expanded</span><span class="op">$</span><span class="va">Scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">scenarios_unique</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine</span></span>
<span><span class="va">combined_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">historical_expanded</span>, <span class="va">scenarios</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Simulation</span>, <span class="va">Type</span>, <span class="va">Region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Catch</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">Scenario</span>, <span class="va">Simulation</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Historical"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Projection"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projall_catch.png"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Simulation</span>, <span class="va">Type</span>, <span class="va">Region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Catch</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projzoom_catch.png"></p>
</div>
<div class="section level4">
<h4 id="catch-advice-under-f_40">Catch Advice under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math><a class="anchor" aria-label="anchor" href="#catch-advice-under-f_40"></a>
</h4>
<p>Catch advice is summarized by projecting forward under Scenario 1,
which applies the harvest control rule with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mn>40</mn><mi>%</mi></mrow></msub><annotation encoding="application/x-tex">F_{40\%}</annotation></semantics></math>
as the maximum allowable fishing mortality. The plots show the mean
projected catch with 95% uncertainty intervals across simulations,
providing the expected range of allowable catch in future years under
this strategy.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span>, <span class="va">Scenario</span> <span class="op">==</span> <span class="st">"S1: FABC (F40)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Simulation</span>, <span class="va">Type</span>, <span class="va">Region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span>, <span class="va">Scenario</span> <span class="op">==</span> <span class="st">"S1: FABC (F40)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Simulation</span>, <span class="va">Type</span>, <span class="va">Region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Catch</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            Catch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Catch</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projzoom_catch_f40.png"></p>
</div>
<div class="section level4">
<h4 id="fishing-mortality-projections">Fishing Mortality Projections<a class="anchor" aria-label="anchor" href="#fishing-mortality-projections"></a>
</h4>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get historical F</span></span>
<span><span class="va">historical</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">francis_model</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">Fmort</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>                                   dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_regions</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">francis_data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">1976</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="st">"FABC (F40)"</span>,  <span class="co"># or change to match the scenarios you're plotting</span></span>
<span>         Type <span class="op">=</span> <span class="st">"Historical"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var3</span>, Fmort <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all scenario projections</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">all_scenarios_f</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Var2</span> <span class="op">+</span> <span class="fl">2023</span>,</span>
<span>         Scenario <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"S1: FABC (F40)"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"S2: FABC Ratio"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"S3: F Last 5 Years"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"S4: F60 SPR"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"S5: No Fishing"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"S6: FOFL"</span>,</span>
<span>           <span class="va">Var4</span> <span class="op">==</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"S7: FABC -&gt; FOFL"</span>,</span>
<span>           <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Scenario"</span>, <span class="va">Var4</span><span class="op">)</span></span>
<span>         <span class="op">)</span>,</span>
<span>         Type <span class="op">=</span> <span class="st">"Projection"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Region <span class="op">=</span> <span class="va">Var1</span>, Simulation <span class="op">=</span> <span class="va">Var3</span>, Fmort <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># expand historical F for plotting</span></span>
<span><span class="va">scenarios_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">$</span><span class="va">Scenario</span><span class="op">)</span></span>
<span><span class="va">historical_expanded</span> <span class="op">&lt;-</span> <span class="va">historical</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scenarios_unique</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">historical_expanded</span><span class="op">$</span><span class="va">Scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">scenarios_unique</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">historical</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine</span></span>
<span><span class="va">combined_fmort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">historical_expanded</span>, <span class="va">scenarios</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_fmort</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Fmort</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">Scenario</span>, <span class="va">Simulation</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Historical"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Projection"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Fully Selected Fishing Mortality'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projall_f.png"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_fmort</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">2024</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Scenario</span>, <span class="va">Type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Fmort</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>            upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Fmort</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            Fmort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Fmort</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Fmort</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Scenario</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Fully Selected Fishing Mortality'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/o_projzoom_f.png"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Cheng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
